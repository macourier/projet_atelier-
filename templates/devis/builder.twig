{% extends 'layout.twig' %}

{% block title %}Catalogue{% endblock %}

{% block content %}

  {# Bloc coordonnées client supprimé sur la page d'accueil /catalogue #}

  <form method="post" action="/devis/pdf/direct" target="_blank"
        x-data="ticketForm()"
        x-init="recalc(); loadDevisDraft()"
        @change="recalc()" @input="recalc()"
        @add-bike-sale.window="addBikeSale($event.detail)"
        @recalc-needed.window="recalc()">
    {% if client %}
      <input type="hidden" name="client_id" value="{{ client.id }}">
    {% endif %}

    {# Champ description supprimé sur la page d'accueil /catalogue #}

<h2 class="title-emph">Catalogue</h2>
<style>
  /* Masquer les flèches des inputs numériques (seulement pour .price-input) */
  input.price-input[type=number]::-webkit-outer-spin-button,
  input.price-input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  input.price-input[type=number] {
    -moz-appearance: textfield;
    appearance: textfield;
    height: 20px;
    min-height: 20px;
    line-height: 20px;
    font-size: .8rem;
    padding: 0 .35rem;
  }
  
  /* Ligne MO/Pièce structurée */
  .line-mo-piece {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    min-height: 32px;
  }
  
  /* Zone gauche: label */
  .line-mo-piece .zone-left {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1 1 auto;
    min-width: 0;
  }
  
  /* Zone centre: quantité (resté pour compat, mais plus utilisé dans le nouveau layout) */
  .line-mo-piece .zone-center {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    flex: 0 0 auto;
    min-width: 70px;
  }
  
  /* Zone droite: icônes */
  .line-mo-piece .zone-right {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 0 0 auto;
    min-width: 120px;
    justify-content: flex-end;
  }
  
  /* Select quantité compact (UI PC) - Taille réduite de 50% */
  .qty-compact {
    width: 26px;
    height: 18px;
    padding: 0 2px;
    font-size: .65rem;
    border-radius: 3px;
    border: 1px solid #D1D5DB;
    background-color: #FFFFFF;
    color: #111827;
    text-align: center;
    appearance: none;
    line-height: 1;
    min-height: 18px;
    max-height: 18px;
  }

  .qty-compact:focus {
    outline: none;
    border-color: #93C5FD;
    box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
  }

  .qty-label {
    font-size: .7rem;
    color: #9CA3AF;
    margin: 0 4px;
    white-space: nowrap;
  }

  /* Wrapper quantité avec largeur fixe (Option B - alignement parfait) */
  .qty-cell {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    min-width: 90px;
  }

  /* Wrapper prix avec largeur fixe pour éviter les décalages lors de l'édition */
  .price-cell {
    min-width: 80px;
    max-width: 80px;
    text-align: right;
    display: inline-block;
  }

  .mo-label {
    font-size: .9rem;
    font-weight: 700;
    color: #111827;
    padding: 2px 6px;
    border-radius: 999px;
    background: rgba(37, 99, 235, 0.06);
  }

  .mo-price {
    font-size: .9rem;
    font-weight: 600;
    color: #111827;
    margin-left: 6px;
  }

  .piece-label {
    display: inline-block;
    max-width: 18ch;
    font-size: .9rem;
    font-weight: 600;
    color: #111827;
    line-height: 1.3;
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    max-height: calc(1.3em * 2);
    overflow: hidden;
  }

  .piece-price {
    font-size: .85rem;
    font-weight: 600;
    color: #111827;
    margin-left: 6px;
    white-space: nowrap;
  }

  .prestation .label .title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .presta-title {
    font-weight: 600;
    color: #111827;
  }

  .mo-header {
    font-size: .85rem;
    font-weight: 600;
    color: #111827;
    white-space: nowrap;
  }
  
  /* Icônes inline sans encadrement */
  .icon-inline {
    background: transparent;
    border: none;
    padding: 2px;
    cursor: pointer;
    opacity: 0.5;
    transition: opacity 0.2s ease, transform 0.1s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .icon-inline:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  
  .icon-inline:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  .icon-inline img {
    width: 16px;
    height: 16px;
    vertical-align: middle;
  }

  /* Cartes dans les tuiles (fond gris très pâle) */
  .category .row-card {
    background: #FAFAFA;
    border: 1px solid #E5E5E5;
    transition: background 0.2s ease, border-color 0.2s ease;
  }
  
  /* Carte cochée en bleu pâle */
  .category .row-card.checked {
    background: #F0F6FF;
    border-color: #D6E4FF;
  }
  
  /* Footer pour fermer l'accordéon */
  .category-footer {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 14px 16px;
    cursor: pointer;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    transition: background 0.25s ease;
    font-size: 15px;
    color: #6b7280;
    margin-top: 8px;
  }
  
  .category-footer:hover {
    background: #f3f4f6;
  }
  
  .category-footer:active {
    transform: scale(0.98);
  }
</style>

    <div id="piece-help-banner" role="status" aria-live="polite" style="margin:10px 0 12px; background:#FFFBEB; border:1px solid #FBC02D; color:#1C1C1C; padding:10px 12px; border-radius:12px; display:none;">
      <div style="font-weight:700; margin-bottom:4px;">Aide — Prix de base Pièce non visible</div>
      <div style="font-size:.95rem;">
        - Rafraîchir la page (Ctrl+F5) après sauvegarde dans l’Admin.<br>
        - Vérifier que “Prix pièce” n’est pas 0 dans l’Admin Prestations.<br>
        - Recharger le catalogue après l’enregistrement (éviter les onglets anciens).
      </div>
      <div class="flex" style="gap:8px; margin-top:8px; flex-wrap:wrap;">
        <a class="btn btn-ghost btn-ghost-sm" href="/admin/prestations">Ouvrir l’Admin Prestations</a>
        <a class="btn btn-ghost btn-ghost-sm" href="mailto:{{ env.COMPANY_EMAIL|default('contact@example.com') }}?subject=Retour%20Prix%20Pi%C3%A8ce&body=Expliquez%20votre%20cas%20:%0A-%20Prestation%20:%20...%0A-%20Prix%20pi%C3%A8ce%20saisi%20:%20...%0A-%20Heure%20:%20...%0A-%20Capture%20:%20...">Envoyer un retour</a>
        <button type="button" class="btn btn-ghost btn-ghost-sm" onclick="localStorage.setItem('hide_piece_banner','1'); document.getElementById('piece-help-banner').style.display='none';">Ne plus afficher</button>
      </div>
    </div>
    <script>
      (function(){
        try{
          if(localStorage.getItem('hide_piece_banner')!=='1'){
            var b=document.getElementById('piece-help-banner');
            if(b) b.style.display='block';
          }
        }catch(_e){}
      })();
    </script>

    {% set tvadef = env.TVA_DEFAULT|default(20) %}
    <div x-data="{ openCat: null }">
    {% for cat, items in catalogue|default({}) %}
      <div class="category" x-data="{ id: '{{ cat|e('js') }}' }" :class="{ 'open': openCat === id }">
        <div class="category-header"
             role="button"
             tabindex="0"
             :aria-expanded="openCat === id ? 'true' : 'false'"
             @click="openCat = (openCat === id ? null : id); $nextTick(() => { $el.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' }); })"
             @keydown.enter.prevent="openCat = (openCat === id ? null : id)"
             @keydown.space.prevent="openCat = (openCat === id ? null : id)">
          <div style="font-weight:700; display:flex; align-items:center; gap:.5rem;">
            {{ cat }}
          </div>
        </div>
        <div class="prestations">
          {% for item in items %}
            <div class="prestation row-card" data-id="{{ item.id }}" 
                 :class="{ 'checked': checked || pieceChecked }"
                 x-data="{
                    checked:false, pieceChecked:false, 
                    moQty:1, pieceQty:1, 
                    moBase:0, pieceBase:0, 
                    moEdit:false, pieceEdit:false, 
                    moInput:'', pieceInput:'',
                    pieceLabel:'',
                    moFinal(){ return this.moInput!=='' && !isNaN(+this.moInput) ? +this.moInput : this.moBase; },
                    pieceFinal(){ return this.pieceInput!=='' && !isNaN(+this.pieceInput) ? +this.pieceInput : this.pieceBase; },
                    moValid(){ return this.moInput!=='' && !isNaN(+this.moInput); },
                    pieceValid(){ return this.pieceInput!=='' && !isNaN(+this.pieceInput); },
                    resetMo(){ this.moInput=''; this.moQty=1; },
                    resetPiece(){ this.pieceInput=''; this.pieceQty=1; },
                    sanitizePrice(val){
                      let s = String(val ?? '').replace(',', '.').replace(/[^\d.]/g, '');
                      let num = parseFloat(s);
                      if (isNaN(num) || num < 0) return '';
                      if (num > 9999) num = 9999;
                      return num.toString().slice(0, 7);
                    }
                 }"
                 x-init="moBase=parseFloat($el.dataset.price)||0; pieceBase=parseFloat($el.dataset.piecePrice)||0; baseTva=parseFloat($el.dataset.tva)||20; pieceLabel=($el.dataset.pieceLabel || 'Pièce').slice(0, 19)"
                 data-price="{{ item.prix_main_oeuvre_ht|default(0) }}"
                 data-tva="{{ item.tva_pct|default(tvadef) }}"
                 data-piece-price="{{ item.piece_prix_ht|default(0) }}"
                 data-piece-label="{{ item.piece_libelle|default('Pièce') }}">
              <input type="checkbox" class="round prest-check" style="width:20px;height:20px"
                      x-model="checked" @change="if($el.checked){ pieceChecked = true; } $dispatch('recalc-needed')">
              <div class="label">
                <div class="title-row">
                  <span class="presta-title">{{ item.libelle }}</span>
                </div>
              </div>

              <input type="hidden" name="prest_id[]" value="{{ item.id }}" :disabled="!checked">

              <div class="row-body" style="display:flex; flex-direction:column; gap:10px;">
                <!-- Ligne Main d'œuvre -->
                <div class="line-mo-piece">
                  <div class="zone-left">
                    <span class="mo-label">MO :</span>

                    <span class="mo-price" x-text="Number(moFinal() || 0).toFixed(2) + ' €'">
                      {{ (item.prix_main_oeuvre_ht|default(0))|number_format(2, ',', ' ') }} €
                    </span>

                    <span class="qty-label">Qté</span>
                    <select name="qty[]" :disabled="!checked" x-model="moQty" @change="$dispatch('recalc-needed')" class="qty-compact">
                      <option value="1">1</option>
                      <option value="2">2</option>
                    </select>
                  </div>

                  <div class="zone-right">
                    <div x-show="!moEdit" style="display:flex; align-items:center; gap:4px;">
                      <button type="button" :disabled="!checked" @click="moEdit=true" x-transition title="Modifier le prix MO" class="icon-inline">
                        <img src="/img/crayon-de-couleur.png" alt="Modifier">
                      </button>
                      <button type="button" title="Réinitialiser MO" x-show="moInput!==''" x-transition @click="resetMo(); $root.recalc()" class="icon-inline">
                        <img src="/img/annuler.png" alt="Réinitialiser">
                      </button>
                    </div>
                    <div x-show="moEdit" x-transition style="display:flex; align-items:center; gap:4px;">
                      <input type="number" step="0.01" min="0" max="9999" inputmode="decimal" :disabled="!checked" class="price-input"
                             x-model="moInput" @input="moInput = sanitizePrice(moInput); $root.recalc()" 
                             style="width:75px; padding:3px 6px; font-size:.85rem; border:1px solid #3b82f6; border-radius:4px;">
                      <button type="button" x-show="moValid()" @click="if(moValid()){ moEdit=false; $root.recalc(); }" x-transition
                              style="padding:3px 8px; font-size:.8rem; background:#3b82f6; color:#fff; border:none; border-radius:4px; cursor:pointer;">✓</button>
                    </div>
                  </div>
                </div>

                <!-- Ligne Pièce -->
                <div class="line-mo-piece">
                  <div class="zone-left" style="gap:10px;">
                    <input type="checkbox" class="round piece-check" style="width:16px;height:16px; margin-right:4px;" x-model="pieceChecked" @change="$root.recalc()">
                    <span class="piece-label" x-text="pieceLabel">
                      {{ item.piece_libelle|default('Pièce') }}
                    </span>

                    <span class="piece-price" x-text="Number(pieceFinal() || 0).toFixed(2) + ' €'">
                      {{ (item.piece_prix_ht|default(0))|number_format(2, ',', ' ') }} €
                    </span>

                    <span class="qty-label">Qté</span>
                    <select name="piece_qty[]" :disabled="!pieceChecked" x-model="pieceQty" @change="$root.recalc()" class="qty-compact">
                      <option value="1">1</option>
                      <option value="2">2</option>
                    </select>
                  </div>

                  <div class="zone-right">
                    <span class="piece-price" x-text="Number(pieceFinal() || 0).toFixed(2) + ' €'">
                      {{ (item.piece_prix_ht|default(0))|number_format(2, ',', ' ') }} €
                    </span>
                    <div x-show="!pieceEdit" style="display:flex; align-items:center; gap:4px;">
                      <button type="button" :disabled="!pieceChecked" @click="pieceEdit=true" x-transition title="Modifier le prix Pièce" class="icon-inline">
                        <img src="/img/crayon-de-couleur.png" alt="Modifier">
                      </button>
                      <button type="button" title="Réinitialiser Pièce" x-show="pieceInput!==''" x-transition @click="resetPiece(); $root.recalc()" class="icon-inline">
                        <img src="/img/annuler.png" alt="Réinitialiser">
                      </button>
                    </div>
                    <div x-show="pieceEdit" x-transition style="display:flex; align-items:center; gap:4px;">
                      <input type="number" step="0.01" min="0" max="9999" inputmode="decimal" :disabled="!pieceChecked" class="price-input"
                             x-model="pieceInput" @input="pieceInput = sanitizePrice(pieceInput); $root.recalc()" 
                             style="width:75px; padding:3px 6px; font-size:.85rem; border:1px solid #3b82f6; border-radius:4px;">
                      <button type="button" x-show="pieceValid()" @click="if(pieceValid()){ pieceEdit=false; $root.recalc(); }" x-transition
                              style="padding:3px 8px; font-size:.8rem; background:#3b82f6; color:#fff; border:none; border-radius:4px; cursor:pointer;">✓</button>
                    </div>
                  </div>
                </div>

                <!-- Inputs masqués pour POST (persistance) -->
                <input type="hidden" name="price_override[]" :value="moInput" :disabled="!checked">
                <input type="hidden" name="piece_price_override[]" :value="pieceInput" :disabled="!pieceChecked">
              </div>
            </div>
          {% endfor %}
        </div>
        
        {# Footer pour fermer la catégorie (visible uniquement si ouverte) #}
        <template x-if="openCat === id">
          <div class="category-footer"
               role="button"
               tabindex="0"
               @click="openCat = null; $nextTick(() => { document.querySelector('.category[x-data] .category-header').scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' }); })"
               @keydown.enter.prevent="openCat = null"
               @keydown.space.prevent="openCat = null">
            <div style="font-size:1.3rem; display:flex; align-items:center; justify-content:center;">
              ↑
            </div>
          </div>
        </template>
      </div>
    {% else %}
      <p class="text-muted">Le catalogue est vide. Allez dans Administration → Prestations pour le remplir.</p>
    {% endfor %}

    {# Tuile spéciale: Vente de vélo (toujours en dernier) #}
    <div class="category" x-data="{ id: '_bike_sale' }" :class="{ 'open': openCat === id }" data-cat="_bike_sale">
      <div class="category-header"
           role="button"
           tabindex="0"
           :aria-expanded="openCat === id ? 'true' : 'false'"
           @click="openCat = (openCat === id ? null : id); $nextTick(() => { $el.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' }); })"
           @keydown.enter.prevent="openCat = (openCat === id ? null : id)"
           @keydown.space.prevent="openCat = (openCat === id ? null : id)">
          <div style="font-weight:700; display:flex; align-items:center; gap:.5rem;">
            Vente de vélo
          </div>
      </div>
      <template x-if="openCat === id"><div class="prestations">
        <div class="row-card" x-data style="display:flex; flex-direction:column; gap:8px;">
          <div>
            <label>Modèle du vélo</label>
            <input x-ref="bikeModel" type="text" class="input">
          </div>
          <div>
            <label>Prix du vélo</label>
            <input x-ref="bikePrice" type="number" step="0.01" inputmode="decimal" class="input">
          </div>
          <div>
            <button type="button" class="btn btn-secondary"
                    @click.prevent="
                      $dispatch('add-bike-sale', { model: $refs.bikeModel.value, price: $refs.bikePrice.value });
                      openCat = null;
                      $refs.bikeModel.value = '';
                      $refs.bikePrice.value = '';
                    ">
              Ajouter
            </button>
          </div>
        </div>
      </div></template>
    </div>
    </div>

    {% include 'components/catalogue_recap.twig' %}

    <div class="footer-sticky">
      <div class="total-pill">

        <span class="total-label">Total</span>
        <span class="total-amount" id="t-total">0.00</span>
        <span class="text-muted" style="font-size:.9rem;">€</span>
      </div>
      <div class="flex gap-8">
        <button class="btn btn-secondary btn-outline-primary" type="button" onclick="saveDevisDraft(); return openDevisModal();">
          <i class="fas fa-file-invoice" style="margin-right:6px;"></i>Devis PDF
        </button>
        <button class="btn btn-secondary btn-outline-primary" type="button" onclick="saveDevisDraft(); return openClientSelectModal();">
          <i class="fas fa-user" style="margin-right:6px;"></i><span>Client</span><img src="/img/dossier-ouvert.png" alt="" aria-hidden="true" width="16" height="16" style="margin-left:6px; vertical-align:middle; position:relative; top:-1px; opacity:.9;">
        </button>
        <a class="btn btn-primary" href="javascript:void(0)" onclick="saveDevisDraft(); return goNewClient();">
          <i class="fas fa-user-plus" style="margin-right:6px;"></i>Nouveau client
        </a>
      </div>
    </div>
  </form>

  <!-- Modal infos client (optionnel) pour PDF direct -->
  <div id="devis-modal" style="position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:2000;">
    <div style="background:#fff; padding:16px; border-radius:12px; width:90%; max-width:420px;">
      <h3 style="margin-top:0;">Informations client (optionnel)</h3>
      <div class="form-field">
        <label for="m_name">Nom</label>
        <input id="m_name" type="text" placeholder="Nom (optionnel)">
      </div>
      <div class="form-field">
        <label for="m_phone">Téléphone</label>
        <input id="m_phone" type="text" placeholder="Téléphone (optionnel)">
      </div>
      <div class="form-field">
        <label for="m_brand">Marque du vélo</label>
        <input id="m_brand" type="text" placeholder="Marque du vélo (optionnel)">
      </div>
      <div class="flex gap-8" style="justify-content:flex-end;">
        <button type="button" class="btn btn-ghost btn-ghost-sm" onclick="closeDevisModal()">Annuler</button>
        <button type="button" class="btn btn-secondary" onclick="submitDirectPdf()">Continuer</button>
      </div>
    </div>
  </div>

  <div id="client-select-modal" style="position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:2000;">
    <div style="background:#fff; padding:16px; border-radius:12px; width:92%; max-width:520px;">
      <h3 style="margin-top:0;">Sélectionner un client</h3>
      <div class="form-field">
        <input id="client-search-input" type="text" placeholder="Rechercher un client…" oninput="debouncedClientSearch()" style="width:100%;">
      </div>
      <div id="client-search-results" style="max-height:300px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:6px;"></div>
      <div class="flex gap-8" style="justify-content:flex-end; margin-top:10px;">
        <button type="button" class="btn btn-ghost btn-ghost-sm" onclick="closeClientSelectModal()">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Modale de validation du ticket (client sélectionné) -->
  <div id="ticket-validation-modal" style="position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:2000;">
    <div style="background:#fff; padding:20px; border-radius:12px; width:95%; max-width:500px; max-height:90vh; overflow-y:auto;">
      <h3 style="margin-top:0;">Créer le ticket</h3>
      <div class="form-field">
        <label for="tv_client_name">Nom du client</label>
        <input id="tv_client_name" type="text" readonly style="background:#f5f5f5; color:#666;">
      </div>
      <div class="form-field">
        <label for="tv_bike_model">Modèle du vélo</label>
        <input id="tv_bike_model" type="text" class="input">
      </div>
      <div class="form-field">
        <label for="tv_email">Email</label>
        <input id="tv_email" type="email" class="input">
      </div>
      <div class="form-field">
        <label for="tv_phone">Téléphone</label>
        <input id="tv_phone" type="tel" class="input">
      </div>
      <div class="form-field">
        <label for="tv_note">Note interne</label>
        <textarea id="tv_note" rows="3" class="input"></textarea>
      </div>
      <div class="flex gap-8" style="justify-content:flex-end; margin-top:16px;">
        <button type="button" class="btn btn-ghost btn-ghost-sm" onclick="closeTicketValidationModal()">Annuler</button>
        <button type="button" class="btn btn-secondary" onclick="submitTicketValidation()">Créer le ticket</button>
      </div>
    </div>
  </div>

  {% include 'components/pave_numerique.twig' %}

  <script>
    function ticketForm(){
      return {
        lastTotal: 0,
        pending: [],
        bikeSales: [],
        fmt(n){ const v = Number(n); return Number.isFinite(v) ? v.toFixed(2) : '0.00'; },
        recalc(){
          this.pending = [];
          let total = 0;
          document.querySelectorAll('.prestation').forEach((row)=>{
            const moCb = row.querySelector('input.prest-check');
            const pieceCb = row.querySelector('input.piece-check');
            const includeRow = ((moCb && moCb.checked) || (pieceCb && pieceCb.checked));
            if (!includeRow) return;

            // MO
            let qty = 0, price = 0;
            if (moCb && moCb.checked) {
              const qtyEl = row.querySelector("select[name='qty[]']") || row.querySelector("input[name='qty[]']");
              const ovEl  = row.querySelector("input[name='price_override[]']");
              qty = parseFloat(qtyEl?.value || '0'); if (isNaN(qty) || qty < 0) qty = 0;
              price = parseFloat(ovEl?.value || '');
              if (isNaN(price)) price = parseFloat(row.dataset.price || '0');
            }

            // Pièce
            let pqty = 0, pprice = 0;
            if (pieceCb && pieceCb.checked) {
              const pQtyEl = row.querySelector("select[name='piece_qty[]']");
              const pOvEl  = row.querySelector("input[name='piece_price_override[]']");
              pqty = parseFloat(pQtyEl?.value || '0'); if (isNaN(pqty) || pqty < 0) pqty = 0;
              pprice = parseFloat(pOvEl?.value || '');
              if (isNaN(pprice)) pprice = parseFloat(row.dataset.piecePrice || '0');
            }

            const lineTotal = (qty * price) + (pqty * pprice);
            total += lineTotal;

            // Calcul pour le récap (type ticket) : unitaire / sous-total
            const labelEl = row.querySelector('.label > div');
            const label = labelEl ? labelEl.textContent.trim() : '';
            const pieceLabel = (row.dataset.pieceLabel || 'Pièce').slice(0, 19);
            const totalQty = (qty || 0) + (pqty || 0);
            const unit = totalQty > 0 ? (lineTotal / totalQty) : 0;

            this.pending.push({
              id: row.dataset.id,
              label: label,
              pieceLabel: pieceLabel,
              // quantité totale (MO + Pièce)
              qty: totalQty,
              // détails conservés pour d'autres usages
              moQty: qty,
              pieceQty: pqty,
              moUnit: price,
              pieceUnit: pprice,
              moTotal: qty * price,
              pieceTotal: pqty * pprice,
              // pour le tableau unifié
              unit: unit,
              subtotal: lineTotal,
              total: lineTotal
            });
          });

          // Intégrer les ventes de vélo (bikeSales) dans pending + total
          if (Array.isArray(this.bikeSales)) {
            this.bikeSales.forEach((sale, idx) => {
              const unit = Number(sale.unit || 0);
              const qty = Number(sale.qty || 1);
              const subtotal = Number(
                sale.subtotal !== undefined && sale.subtotal !== null
                  ? sale.subtotal
                  : unit * qty
              );
              total += subtotal;
              this.pending.push({
                type: 'bike',
                id: sale.id || ('bike-' + idx),
                label: sale.label || 'Vente de vélo',
                qty: qty,
                moQty: 0,
                pieceQty: 0,
                moUnit: 0,
                pieceUnit: 0,
                moTotal: 0,
                pieceTotal: 0,
                unit: unit,
                subtotal: subtotal,
                total: subtotal
              });
            });
          }

          const fmt = (n) => Number(n).toFixed(2);
          const totalEl = document.getElementById('t-total');
          if (totalEl) {
            totalEl.textContent = fmt(total);
            // Inject CSS bounce once
            if (!document.getElementById('css-total-bounce')) {
              const st = document.createElement('style');
              st.id = 'css-total-bounce';
              st.textContent = '@keyframes totalBounce{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}} .total-pill.bounce{animation:totalBounce .32s ease-in-out}';
              document.head.appendChild(st);
            }
            const pill = document.querySelector('.total-pill');
            if (pill && total !== this.lastTotal) {
              pill.classList.add('bounce');
              setTimeout(()=>pill.classList.remove('bounce'), 360);
              this.lastTotal = total;
            }
          }
        },

        // Nouvelle méthode Vente de vélo (Alpine)
        addBikeSale(detail){
          const model = String(detail?.model || '').trim();
          let price = Number(String(detail?.price || '').replace(',', '.'));

          if (!model) { alert('Saisir le modèle du vélo'); return; }
          if (!Number.isFinite(price) || price < 0) { alert('Saisir un prix valide'); return; }

          if (!Array.isArray(this.bikeSales)) this.bikeSales = [];
          this.bikeSales.push({
            label: 'Vente de vélo — ' + model,
            qty: 1,
            unit: price,
            subtotal: price
          });

          // Sauvegarder le dernier modèle de vélo pour pré-remplir le formulaire client
          try {
            localStorage.setItem('lastBikeModel', model);
          } catch(_e) {}

          try {
            let draft;
            try {
              draft = JSON.parse(localStorage.getItem('devisDraft') || 'null') || {};
            } catch(_e) {
              draft = {};
            }
            if (!draft.custom) draft.custom = {};
            if (!Array.isArray(draft.custom.prest)) draft.custom.prest = [];
            draft.custom.prest.push({
              label: 'Vente de vélo — ' + model,
              price: price
            });
            localStorage.setItem('devisDraft', JSON.stringify(draft));
          } catch(_e) {}

        if (typeof this.recalc === 'function') this.recalc();
        if (typeof this.toast === 'function') this.toast('Vente de vélo ajoutée ✓');
        },
        removePending(idx){
          if (idx >= 0 && idx < this.pending.length) {
            this.pending = this.pending.filter((_, i) => i !== idx);
            this.recalc();
            const t=document.createElement('div'); t.className='toast'; t.textContent='Ligne supprimée ✓'; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 3000);
          }
        },
        removeMo(id){
          // Décocher seulement la checkbox MO 
          const row = document.querySelector(`.prestation[data-id="${id}"]`);
          if (row) {
            const moCb = row.querySelector('input.prest-check');
            if (moCb) moCb.checked = false;
          }
          this.recalc();
          const t=document.createElement('div'); t.className='toast'; t.textContent='Ligne supprimée ✓'; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 3000);
        },
        removePiece(id){
          // Décocher seulement la checkbox Pièce
          const row = document.querySelector(`.prestation[data-id="${id}"]`);
          if (row) {
            const pieceCb = row.querySelector('input.piece-check');
            if (pieceCb) pieceCb.checked = false;
          }
          this.recalc();
          const t=document.createElement('div'); t.className='toast'; t.textContent='Ligne supprimée ✓'; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 3000);
        },
        removeBikeById(id){
          // Supprimer du tableau bikeSales
          const initialLen = this.bikeSales.length;
          this.bikeSales = this.bikeSales.filter((s) => s.id !== id);
          if (this.bikeSales.length < initialLen) {
            this.recalc();
            const t=document.createElement('div'); t.className='toast'; t.textContent='Vente de vélo supprimée ✓'; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 3000);
          }
        },
        removePendingById(id){
          const initialLen = this.pending.length;
          this.pending = this.pending.filter((p) => p.id !== id);
          if (this.pending.length < initialLen) {
            // Décocher la checkbox correspondante dans le catalogue
            const row = document.querySelector(`.prestation[data-id="${id}"]`);
            if (row) {
              const moCb = row.querySelector('input.prest-check');
              const pieceCb = row.querySelector('input.piece-check');
              if (moCb) moCb.checked = false;
              if (pieceCb) pieceCb.checked = false;
            }
            this.recalc();
            const t=document.createElement('div'); t.className='toast'; t.textContent='Ligne supprimée ✓'; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 3000);
          }
        },
        removeBikeSale(idx){
          if (idx >= 0 && idx < this.bikeSales.length) {
            this.bikeSales = this.bikeSales.filter((_, i) => i !== idx);
            this.recalc();
            const t=document.createElement('div'); t.className='toast'; t.textContent='Vente de vélo supprimée ✓'; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 3000);
          }
        },
      }
    }
    // Sauvegarde locale du brouillon avant navigation (pour "Nouveau client")
    function saveDevisDraft(){
      let draft;
      try{
        draft = JSON.parse(localStorage.getItem('devisDraft') || 'null') || {};
      }catch(_e){
        draft = {};
      }
      draft.rows = [];
      document.querySelectorAll('.prestation').forEach((row)=>{
        const id = row.getAttribute('data-id');
        const moCb = row.querySelector('input.prest-check');
        const pieceCb = row.querySelector('input.piece-check');
        const moQty = row.querySelector("select[name='qty[]']")?.value || '1';
        const moInput = row.querySelector("input[name='price_override[]']")?.value || '';
        const pieceQty = row.querySelector("select[name='piece_qty[]']")?.value || '1';
        const pieceInput = row.querySelector("input[name='piece_price_override[]']")?.value || '';
        draft.rows.push({
          id, checked: !!moCb?.checked, moQty, moInput,
          pieceChecked: !!pieceCb?.checked, pieceQty, pieceInput
        });
      });
      // Conserver aussi les ventes de vélo en custom.prest
      try{
        if (!draft.custom) draft.custom = {};
        if (!Array.isArray(draft.custom.prest)) draft.custom.prest = [];
      }catch(_e){}
      localStorage.setItem('devisDraft', JSON.stringify(draft));
    }
    function loadDevisDraft(){
      try{
        const raw = localStorage.getItem('devisDraft');
        if(!raw) return;
        const draft = JSON.parse(raw);
        if(Array.isArray(draft.rows)){
          draft.rows.forEach((r)=>{
            const row = document.querySelector(`.prestation[data-id='${r.id}']`);
            if(!row) return;
            const moCb = row.querySelector('input.prest-check');
            if(moCb){ moCb.checked = !!r.checked; }
            const moQty = row.querySelector("select[name='qty[]']");
            if(moQty){ moQty.value = r.moQty || '1'; }
            const moOv = row.querySelector("input[name='price_override[]']");
            if(moOv){ moOv.value = r.moInput || ''; }

            const pieceCb = row.querySelector('input.piece-check');
            if(pieceCb){ pieceCb.checked = !!r.pieceChecked; }
            const pQty = row.querySelector("select[name='piece_qty[]']");
            if(pQty){ pQty.value = r.pieceQty || '1'; }
            const pOv = row.querySelector("input[name='piece_price_override[]']");
            if(pOv){ pOv.value = r.pieceInput || ''; }
          });
        }
        // Restaurer les ventes de vélo dans l'état Alpine si présentes
        if (draft && draft.custom && Array.isArray(draft.custom.prest)) {
          const form = document.querySelector('form[x-data]');
          const data = form && form.__x ? form.__x.$data : null;
          if (data) {
            draft.custom.prest.forEach(l=>{
              const lab = String(l?.label || '').trim();
              const pr = Number(String(l?.price || '').replace(',', '.'));
              if (lab && Number.isFinite(pr) && pr >= 0) {
                if (!Array.isArray(data.bikeSales)) data.bikeSales = [];
                data.bikeSales.push({ label: lab, qty: 1, unit: pr, subtotal: pr });
              }
            });
            if (typeof data.recalc === 'function') data.recalc();
          }
        }
        // on recalcule une fois chargé
        if (typeof ticketForm === 'function') {
          const totalEl = document.getElementById('t-total');
          if (totalEl) {
            const e = new Event('input');
            document.body.dispatchEvent(e);
          }
        }
      }catch(e){ console.warn('Devis draft restore error', e); }
    }
    // Lecture des champs coordonnées client (si saisis)
    function readClientFields(){
      const name = (document.getElementById('client_name')?.value || '').trim();
      const address = (document.getElementById('client_address')?.value || '').trim();
      const email = (document.getElementById('client_email')?.value || '').trim();
      const phone = (document.getElementById('client_phone')?.value || '').trim();
      return { name, address, email, phone };
    }
    function markClientValidated(){
      const chk = document.getElementById('client-valid-check');
      if (chk) chk.style.display = 'inline';
      const det = document.querySelector('.bg-white details');
      if (det && det.open) det.open = false;
    }
    function validateClientDraft(){
      const f = readClientFields();
      if (!f.name) { alert('Veuillez saisir au moins le nom du client.'); return false; }
      localStorage.setItem('clientDraft', JSON.stringify(f));
      try { sessionStorage.setItem('clientDraftValidated','1'); } catch(_e){}
      markClientValidated();
      return false;
    }
    // Création d'un client pré-rempli (sans auto-création du ticket)
    function createClientPrefilled(){
      const f = readClientFields();
      const qs = [
        'return=' + encodeURIComponent('/catalogue'),
        f.name ? ('name=' + encodeURIComponent(f.name)) : '',
        f.address ? ('address=' + encodeURIComponent(f.address)) : '',
        f.email ? ('email=' + encodeURIComponent(f.email)) : '',
        f.phone ? ('phone=' + encodeURIComponent(f.phone)) : ''
      ].filter(Boolean).join('&');
      window.location.href = '/clients/0/edit?' + qs;
      return false;
    }
    // Bouton "Nouveau client" en bas:
    // - si client déjà sélectionné: aller au dashboard et auto-créer le ticket
    // - sinon: aller sur création client pré-remplie puis auto-création du ticket après save
    function hasSelectedLines(){
      try{
        const d = JSON.parse(localStorage.getItem('devisDraft') || 'null');
        if (d && Array.isArray(d.rows)) {
          return d.rows.some(r => !!r?.checked || !!r?.pieceChecked);
        }
      }catch(_e){}
      // fallback DOM scan
      let any = false;
      document.querySelectorAll('.prestation').forEach((row)=>{
        const mo = row.querySelector('input.prest-check');
        const pc = row.querySelector('input.piece-check');
        if ((mo && mo.checked) || (pc && pc.checked)) any = true;
      });
      return any;
    }
    function goNewClient(){
      const autostart = hasSelectedLines();
      // Récupérer le dernier modèle de vélo si disponible
      let bikeModel = '';
      try {
        bikeModel = localStorage.getItem('lastBikeModel') || '';
      } catch(_e) {}
      
      // Toujours créer un nouveau client (ne pas réutiliser un client_id existant)
      const live = readClientFields();
      const hasLive = !!(live && (live.name || live.address || live.email || live.phone));
      let f = null;
      if (hasLive) {
        f = live;
        try{ localStorage.setItem('clientDraft', JSON.stringify(f)); }catch(_e){}
      } else {
        const validated = (sessionStorage.getItem('clientDraftValidated') === '1');
        if (validated) {
          try{
            f = JSON.parse(localStorage.getItem('clientDraft') || 'null');
          }catch(_e){}
        }
      }
      if (f && f.name) {
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '/clients/0/edit';
        const add = (n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i); };
        add('return','/catalogue');
        add('auto_create','1');
        if (autostart) {
          add('autostart','1');
          // Joindre les lignes sélectionnées au POST pour création serveur du ticket
          try{
            const raw = localStorage.getItem('devisDraft');
            const draft = raw ? JSON.parse(raw) : null;
            if (draft && Array.isArray(draft.rows)) {
              draft.rows.forEach(r=>{
                if (r.checked || r.pieceChecked) {
                  add('prest_id[]', r.id || '');
                  add('qty[]', r.moQty || '1');
                  add('price_override[]', r.moInput || '');
                  add('piece_qty[]', r.pieceQty || '0');
                  add('piece_price_override[]', r.pieceInput || '');
                }
              });
            }
            // Indicateur pour le serveur
            add('_create_ticket_from_builder','1');
          }catch(_e){}
        }
        add('name', f.name || '');
        add('address', f.address || '');
        add('email', f.email || '');
        add('phone', f.phone || '');
        if (bikeModel) {
          add('bike_model', bikeModel);
          // Nettoyer le localStorage après utilisation pour éviter la persistance
          try {
            localStorage.removeItem('lastBikeModel');
          } catch(_e) {}
        }
        document.body.appendChild(form);
        form.submit();
        return false;
      }
      // Rien saisi → bascule sur l'édition client (vierge)
      const params = ['return=' + encodeURIComponent('/catalogue')];
      if (bikeModel) {
        params.push('bike_model=' + encodeURIComponent(bikeModel));
      }
      window.location.href = '/clients/0/edit?' + params.join('&');
      return false;
    }
    function preSubmitPdf(){
      const form = document.querySelector('form[action="/tickets/0/edit"]');
      // Client déjà sélectionné → soumission directe en PDF
      const cidEl = document.querySelector('input[name="client_id"]');
      const cid = cidEl ? String(cidEl.value || '') : '';
      if (cid) { form.submit(); return false; }

      // Pas de client: tenter à partir du brouillon validé
      let f = null;
      try{ f = JSON.parse(localStorage.getItem('clientDraft') || 'null'); }catch(_e){}
      if (!f || !f.name) {
        if (typeof readClientFields === 'function') {
          const tmp = readClientFields();
          if (tmp && tmp.name) f = tmp;
        }
      }
      if (f && f.name) {
        // Sauvegarder brouillon devis (lignes) puis créer le client en POST silencieux avec pdf=1
        if (typeof saveDevisDraft === 'function') { saveDevisDraft(); }
        const cform = document.createElement('form');
        cform.method = 'post';
        cform.action = '/clients/0/edit';
        const add = (n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; cform.appendChild(i); };
        add('return','/catalogue');
        add('auto_create','1');
        add('pdf','1');
        add('name', f.name || '');
        add('address', f.address || '');
        add('email', f.email || '');
        add('phone', f.phone || '');
        document.body.appendChild(cform);
        cform.submit();
        return false;
      }

      // Rien saisi → ouvrir la section coordonnées et notifier
      const det = document.querySelector('.bg-white details');
      if (det) det.open = true;
      alert('Veuillez saisir les coordonnées du client avant de générer le PDF.');
      return false;
    }

    (function(){
      try{
        // Réinitialiser le flag de validation à chaque arrivée sur /devis/new
        sessionStorage.setItem('clientDraftValidated','0');
        const cd = JSON.parse(localStorage.getItem('clientDraft') || 'null');
        if (cd && cd.name) { markClientValidated(); }
      }catch(_e){}
    })();
    // Modal PDF direct
    function openDevisModal(){
      const m = document.getElementById('devis-modal');
      if (m) { m.style.display = 'flex'; }
      return false;
    }
    function closeDevisModal(){
      const m = document.getElementById('devis-modal');
      if (m) { m.style.display = 'none'; }
      return false;
    }
    function hasSelectedLines(){
      try{
        const d = JSON.parse(localStorage.getItem('devisDraft') || 'null');
        if (d && Array.isArray(d.rows)) {
          return d.rows.some(r => !!r?.checked || !!r?.pieceChecked);
        }
      }catch(_e){}
      // fallback DOM scan
      let any = false;
      document.querySelectorAll('.prestation').forEach((row)=>{
        const mo = row.querySelector('input.prest-check');
        const pc = row.querySelector('input.piece-check');
        if ((mo && mo.checked) || (pc && pc.checked)) any = true;
      });
      return any;
    }
    function submitDirectPdf(){
      // Vérifier qu'au moins une ligne est sélectionnée
      if (!hasSelectedLines()) { alert('Veuillez sélectionner au moins une prestation.'); return false; }
      const form = document.querySelector('form[action="/devis/pdf/direct"]') || document.querySelector('form');
      if (!form) return false;
      // Nettoyer anciens inputs temporaires
      ['name','phone','brand'].forEach((n)=>{ const old = form.querySelector('input[name="'+n+'"]'); if (old) old.remove(); });
      // Ajouter les inputs depuis le modal
      const add = (n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i); };
      add('name', document.getElementById('m_name')?.value || '');
      add('phone', document.getElementById('m_phone')?.value || '');
      add('brand', document.getElementById('m_brand')?.value || '');
      // Ouvrir dans un nouvel onglet
      form.setAttribute('target','_blank');
      form.submit();
      // Reset page (/catalogue) : vider brouillon et décocher
      try{ localStorage.removeItem('devisDraft'); }catch(_e){}
      document.querySelectorAll('.prestation input.prest-check, .prestation input.piece-check').forEach(el=>{ el.checked=false; });
      document.querySelectorAll("select[name='qty[]']").forEach(el=>{ el.value='1'; });
      document.querySelectorAll("select[name='piece_qty[]']").forEach(el=>{ el.value='1'; });
      document.querySelectorAll("input[name='price_override[]']").forEach(el=>{ el.value=''; });
      document.querySelectorAll("input[name='piece_price_override[]']").forEach(el=>{ el.value=''; });
      // Recalculer total
      const e = new Event('input'); document.body.dispatchEvent(e);
      closeDevisModal();
      return false;
    }
  </script>
  <script>
  function openClientSelectModal(){
    const m = document.getElementById('client-select-modal');
    if(m){ m.style.display='flex'; const i=document.getElementById('client-search-input'); if(i){ i.value=''; i.focus(); } const r=document.getElementById('client-search-results'); if(r){ r.innerHTML=''; } }
    return false;
  }
  function closeClientSelectModal(){ const m=document.getElementById('client-select-modal'); if(m){ m.style.display='none'; } return false; }
  function clientSearch(q){
    q=(q||'').trim();
    const box=document.getElementById('client-search-results');
    if(!box) return;
    if (q.length < 2) {
      box.innerHTML = '<div class="text-muted">Tapez au moins 2 caractères…</div>';
      return;
    }
    fetch('/search?q='+encodeURIComponent(q), { credentials: 'include', headers: { 'Accept': 'text/html' } })
      .then(r=>r.text())
      .then(html=>{
        // Si on a été redirigé vers la page de login (middleware), prévenir l'utilisateur
        if (html.includes('<form') && html.toLowerCase().includes('login')) {
          box.innerHTML = '<div style="color:#b00020">Session expirée — veuillez vous reconnecter.</div>';
          return;
        }
        const parser=new DOMParser();
        const doc=parser.parseFromString(html,'text/html');
        const links=[...doc.querySelectorAll('a[href^="/clients/"]')];
        const items=[];
        links.forEach(a=>{ const m=a.getAttribute('href').match(/^\/clients\/(\d+)/); if(m){ const id=m[1]; const name=(a.textContent||'').trim(); items.push({id,name}); }});
        if(items.length===0){ box.innerHTML='<div class="text-muted">Aucun client</div>'; return; }
        box.innerHTML='';
        items.forEach(it=>{ const row=document.createElement('div'); row.style.cssText='padding:8px; border-bottom:1px solid #f1f5f9; cursor:pointer;'; row.textContent=it.name; row.onclick=()=>selectExistingClient(it.id); box.appendChild(row); });
      })
      .catch(()=>{ box.innerHTML='<div style="color:#b00020">Erreur de recherche</div>'; });
  }
  let _clientSearchTimer=null;
  function debouncedClientSearch(){ clearTimeout(_clientSearchTimer); _clientSearchTimer = setTimeout(()=>{ const i=document.getElementById('client-search-input'); clientSearch(i?i.value:''); }, 250); }
  function selectExistingClient(clientId){
    try{
      if(!localStorage.getItem('devisDraft')){ if(typeof saveDevisDraft==='function'){ saveDevisDraft(); } }
      const raw = localStorage.getItem('devisDraft');
      const draft = raw ? JSON.parse(raw) : null;
      if(!draft){ alert('Aucun brouillon de devis trouvé.'); return; }
      
      // Ouvrir modale de validation au lieu de soumettre directement
      fetch('/clients/' + clientId + '/info')
        .then(r => r.json())
        .then(client => {
          // Pré-remplir la modale
          document.getElementById('tv_client_name').value = client.name || '';
          document.getElementById('tv_email').value = client.email || '';
          document.getElementById('tv_phone').value = client.phone || '';
          document.getElementById('tv_bike_model').value = '';
          document.getElementById('tv_note').value = '';
          
          // Stocker clientId et draft pour la soumission
          window._pendingClientId = clientId;
          window._pendingDraft = draft;
          
          // Ouvrir modale
          openTicketValidationModal();
          closeClientSelectModal();
        })
        .catch(err => {
          console.error(err);
          alert('Erreur lors du chargement des infos client.');
        });
    }catch(e){ console.error(e); alert('Impossible de sélectionner ce client.'); }
  }
  
  function openTicketValidationModal(){
    const m = document.getElementById('ticket-validation-modal');
    if(m){ m.style.display = 'flex'; }
  }
  
  function closeTicketValidationModal(){
    const m = document.getElementById('ticket-validation-modal');
    if(m){ m.style.display = 'none'; }
    window._pendingClientId = null;
    window._pendingDraft = null;
  }
  
  function submitTicketValidation(){
    const clientId = window._pendingClientId;
    const draft = window._pendingDraft;
    if(!clientId || !draft){ alert('Données manquantes.'); return; }
    
    const bikeModel = document.getElementById('tv_bike_model').value.trim();
    const email = document.getElementById('tv_email').value.trim();
    const phone = document.getElementById('tv_phone').value.trim();
    const note = document.getElementById('tv_note').value.trim();
    
    // Créer et soumettre le formulaire
    const form = document.createElement('form');
    form.method = 'post';
    form.action = '/clients/' + String(clientId) + '/select';
    
    const add = (n, v) => { 
      const i = document.createElement('input'); 
      i.type = 'hidden'; 
      i.name = n; 
      i.value = v; 
      form.appendChild(i); 
    };
    
    // Lignes de prestations
    if(Array.isArray(draft.rows)){
      draft.rows.forEach(r=>{
        if(r.checked || r.pieceChecked){
          add('prest_id[]', r.id || '');
          add('qty[]', r.moQty || '1');
          add('price_override[]', r.moInput || '');
          add('piece_qty[]', r.pieceQty || '0');
          add('piece_price_override[]', r.pieceInput || '');
        }
      });
    }
    
    // Prestations/pièces custom
    if(draft && draft.custom){
      try{
        if(Array.isArray(draft.custom.prest)){
          draft.custom.prest.forEach(l=>{ 
            const lab=(l?.label||'').trim(); 
            const pr=Number(String(l?.price??'').replace(',','.')); 
            if(lab!=='' && Number.isFinite(pr) && pr>=0){ 
              add('custom_prest_label[]', lab); 
              add('custom_prest_price[]', String(pr)); 
            } 
          });
        }
        if(Array.isArray(draft.custom.piece)){
          draft.custom.piece.forEach(l=>{ 
            const lab=(l?.label||'').trim(); 
            const pr=Number(String(l?.price??'').replace(',','.')); 
            if(lab!=='' && Number.isFinite(pr) && pr>=0){ 
              add('custom_piece_label[]', lab); 
              add('custom_piece_price[]', String(pr)); 
            } 
          });
        }
      }catch(_e){}
    }
    
    // Champs de validation
    add('bike_model', bikeModel);
    add('email', email);
    add('phone', phone);
    add('note', note);
    
    document.body.appendChild(form);
    form.submit();
    closeTicketValidationModal();
  }
  </script>
{% endblock %}
