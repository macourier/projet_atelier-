{% extends 'layout.twig' %}

{% block title %}Éditer client{% endblock %}

{% block content %}
  <h2 class="page-title-inside">{{ client ? 'Éditer le client' : 'Nouveau client' }}</h2>

  <form method="post" action="/clients/{{ client.id|default(0) }}/edit">
    {% if return is defined and return %}
      <input type="hidden" name="return" value="{{ return }}">
    {% endif %}
    {% if auto_create is defined and auto_create %}
      <input type="hidden" name="auto_create" value="1">
    {% endif %}
    <div class="form-field">
      <label for="name">Nom</label>
      <input id="name" name="name" type="text" required value="{{ client.name|default('') }}">
    </div>
    <div class="form-field">
      <label for="bike_model">Modèle du vélo</label>
      <input id="bike_model" name="bike_model" type="text" value="{{ client.bike_model|default('') }}" autocomplete="off">
    </div>
    <div class="form-field">
      <label for="email">Email</label>
      <input id="email" name="email" type="email" value="{{ client.email|default('') }}">
    </div>
    <div class="form-field">
      <label for="phone">Téléphone</label>
      <input id="phone" name="phone" type="text" value="{{ client.phone|default('') }}">
    </div>
    <div class="form-field">
      <label for="note">Note</label>
      <textarea id="note" name="note" rows="3">{{ client.note|default('') }}</textarea>
    </div>
    <button class="btn" type="submit">Enregistrer</button>
  </form>

  <script>
    // Nettoyer le localStorage et vider le champ après utilisation
    (function(){
      try {
        // Vérifier si on vient du catalogue (avec bike_model dans l'URL)
        const url = new URL(window.location.href);
        const bikeModelParam = url.searchParams.get('bike_model');
        
        // Si le modèle a été utilisé pour pré-remplir, on le retire de l'URL
        // pour éviter qu'il persiste lors d'un rechargement de page
        if (bikeModelParam) {
          url.searchParams.delete('bike_model');
          window.history.replaceState({}, '', url.toString());
        }
        
        // Toujours nettoyer le localStorage pour éviter la réutilisation
        localStorage.removeItem('lastBikeModel');
        
      } catch(_e) {
        // Ignorer les erreurs silencieusement
      }
    })();
    
    // Vider le champ après soumission réussie (quand on revient sur la page)
    window.addEventListener('pageshow', function(event) {
      try {
        // Si la page est chargée depuis le cache (back/forward), vider le champ
        if (event.persisted) {
          const bikeField = document.getElementById('bike_model');
          if (bikeField) {
            bikeField.value = '';
          }
          localStorage.removeItem('lastBikeModel');
        }
      } catch(_e) {}
    });
  </script>
{% endblock %}
