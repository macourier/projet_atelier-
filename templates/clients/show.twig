{% extends 'layout.twig' %}

{% block title %}Dashboard client — {{ client.name|default('Inconnu') }}{% endblock %}

{% block content %}
  <h2 class="page-title-inside">Dashboard client</h2>

  {% if error %}
    <div style="color:#b00020">{{ error }}</div>
  {% endif %}

  {% if client %}
    <div class="card client-card client-card-narrow" style="background:#f9fafb; border:1px solid #E5E7EB; border-radius:14px; box-shadow:0 1px 3px rgba(0,0,0,.05); padding:12px 14px; line-height:1.45; margin:8px 0; font-size:.95rem;">
      <div class="client-row"><span class="client-label">Nom:</span> {{ client.name|default('') }}</div>
      <div class="client-row"><span class="client-label">Email:</span> {{ client.email|default('') }}</div>
      <div class="client-row"><span class="client-label">Téléphone:</span> {{ client.phone|default('') }}</div>
    </div>

    {% set fromDevis = app.request.getQueryParams().from|default('') %}
    {% if fromDevis == 'devis' %}
      <div class="bg-white border shadow" style="padding:10px; border-radius:.75rem; margin:12px 0; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>Brouillon devis détecté</strong><br>
          Vous pouvez créer un ticket à partir des éléments saisis.
        </div>
        <div class="flex gap-8">
          <button class="btn btn-secondary" type="button" onclick="createTicketFromDraft({{ client.id }})">
            <i class="fas fa-file-invoice" style="margin-right:6px;"></i>Créer le ticket depuis devis
          </button>
          <button class="btn btn-ghost btn-ghost-sm" type="button" onclick="localStorage.removeItem('devisDraft'); localStorage.removeItem('clientDraft'); localStorage.removeItem('lastBikeModel'); this.closest('div.bg-white').remove();">
            Ignorer
          </button>
        </div>
      </div>
      <script>
        // Nettoyer le modèle de vélo du localStorage après création du client
        (function(){
          try {
            localStorage.removeItem('lastBikeModel');
          } catch(_e) {}
        })();
      </script>
    {% endif %}

    <div style="display:flex; gap:8px; margin:36px 0;">
      <a class="btn btn-light-primary" href="/clients/{{ client.id|default(0) }}/edit">Éditer le client</a>
      <a class="btn btn-light-primary" href="/tickets/0/edit?client_id={{ client.id }}">Nouveau ticket</a>
    </div>


    {# Section Vélos supprimée — informations vélo désormais sur le Ticket #}

    {# Séparer Tickets ouverts et Tickets clos #}
    {% if tickets is defined and tickets is not empty %}

      {# Construire listes ouvertes/clos #}
      {% set openTickets = [] %}
      {% set closedTickets = [] %}
      {% for t in tickets %}
        {% if t.status == 'open' %}
          {% set openTickets = openTickets|merge([t]) %}
        {% else %}
          {% set closedTickets = closedTickets|merge([t]) %}
        {% endif %}
      {% endfor %}

      <h2 id="tickets-open">Tickets ouverts</h2>
      {% if openTickets is not empty %}
        <table>
          <thead>
            <tr><th>Vélo</th><th>Date de réception</th><th>Total TTC</th><th>Facture</th><th></th></tr>
          </thead>
          <tbody>
            {% for t in openTickets %}
              <tr id="row-ticket-{{ t.id }}">
                <td>{{ t.bike_model|default('—') }}</td>
                <td>{{ t.received_at ? t.received_at|date('d/m/Y H:i') : (t.created_at ? t.created_at|date('d/m/Y H:i') : '—') }}</td>
                <td>{{ '%.2f'|format(t.total_ttc|default(t.total_ht|default(0))) }}</td>
                <td>
                  {% if facturesByTicket is defined and facturesByTicket[t.id]|default(null) and facturesByTicket[t.id].pdf_path %}
                    <a class="btn-soft-red" href="{{ facturesByTicket[t.id].pdf_path }}" target="_blank">Facture PDF</a>
                  {% else %}—{% endif %}
                </td>
                <td><a class="btn-soft-sky" href="/tickets/{{ t.id }}/edit">Ouvrir</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>Aucun ticket ouvert.</p>
      {% endif %}

      <h2 id="tickets-closed" style="margin-top:16px;">Tickets terminés</h2>
      {% if closedTickets is not empty %}
        <table>
          <thead>
            <tr><th>Vélo</th><th>Date de réception</th><th>Total TTC</th><th>Facture</th><th></th></tr>
          </thead>
          <tbody>
            {% for t in closedTickets %}
              <tr id="row-ticket-{{ t.id }}">
                <td>{{ t.bike_model|default('—') }}</td>
                <td>{{ t.received_at ? t.received_at|date('d/m/Y H:i') : (t.created_at ? t.created_at|date('d/m/Y H:i') : '—') }}</td>
                <td>{{ '%.2f'|format(t.total_ttc|default(t.total_ht|default(0))) }}</td>
                <td>
                  {% if facturesByTicket is defined and facturesByTicket[t.id]|default(null) and facturesByTicket[t.id].pdf_path %}
                    <a class="btn-soft-red" href="{{ facturesByTicket[t.id].pdf_path }}" target="_blank">Facture PDF</a>
                  {% else %}—{% endif %}
                </td>
                <td><a class="btn-soft-sky" href="/tickets/{{ t.id }}/edit">Ouvrir</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>Aucun ticket clos.</p>
      {% endif %}

      <script>
        (function(){
          try{
            const u = new URL(window.location.href);
            const ct = u.searchParams.get('created_ticket');
            if (ct) {
              // toast
              const t = document.createElement('div');
              t.className = 'toast';
              t.textContent = 'Ticket créé ✓';
              document.body.appendChild(t);
              setTimeout(()=>{ t.remove(); }, 5000);
              // scroll sur la section "tickets ouverts" et surligner la ligne si présente
              const openSec = document.getElementById('tickets-open');
              if (openSec) openSec.scrollIntoView({behavior:'smooth', block:'start'});
              const row = document.getElementById('row-ticket-' + ct);
              if (row) {
                row.style.outline = '2px solid #3b82f6';
                row.style.outlineOffset = '2px';
                setTimeout(()=>{ row.style.outline=''; row.style.outlineOffset=''; }, 4000);
              }
            }
          }catch(_e){}
        })();
      </script>

    {% else %}
      <p>Aucun ticket pour ce client.</p>
    {% endif %}
  {% else %}
    <p>Client introuvable.</p>
  {% endif %}
  <script>
    function createTicketFromDraft(clientId){
      try{
        const raw = localStorage.getItem('devisDraft');
        const draft = raw ? JSON.parse(raw) : null;
        if (!draft) {
          alert('Aucun brouillon de devis trouvé.');
          return;
        }
        // Construire un formulaire POST caché vers /tickets/0/edit
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '/tickets/0/edit';

        const add = (n,v) => { const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i); };

        add('client_id', String(clientId));
        // Récupérer le modèle depuis le localStorage (vente de vélo) OU depuis l'URL (création client)
        try {
          let bikeModel = localStorage.getItem('lastBikeModel');
          // Fallback: récupérer depuis l'URL si pas dans localStorage
          if (!bikeModel) {
            const u = new URL(window.location.href);
            bikeModel = u.searchParams.get('bike_model');
          }
          if (bikeModel) { 
            add('bike_model', bikeModel);
            // Nettoyer immédiatement pour éviter la réutilisation
            localStorage.removeItem('lastBikeModel');
          }
        } catch(_e){}
        if (Array.isArray(draft.rows)) {
          draft.rows.forEach(r=>{
            // On ne pousse que si coche MO ou Pièce
            if (r.checked || r.pieceChecked) {
              add('prest_id[]', r.id || '');
              add('qty[]', r.moQty || '1');
              add('price_override[]', r.moInput || '');
              add('piece_qty[]', r.pieceQty || '0');
              add('piece_price_override[]', r.pieceInput || '');
            }
          });
        }
        // Lignes personnalisées "Prestation"/"Pièce" depuis la tuile Prestation
        if (draft && draft.custom) {
          try {
            if (Array.isArray(draft.custom.prest)) {
              draft.custom.prest.forEach(l => {
                const lab = (l?.label || '').trim();
                const pr = Number(String(l?.price ?? '').replace(',', '.'));
                if (lab !== '' && Number.isFinite(pr) && pr >= 0) {
                  add('custom_prest_label[]', lab);
                  add('custom_prest_price[]', String(pr));
                }
              });
            }
            if (Array.isArray(draft.custom.piece)) {
              draft.custom.piece.forEach(l => {
                const lab = (l?.label || '').trim();
                const pr = Number(String(l?.price ?? '').replace(',', '.'));
                if (lab !== '' && Number.isFinite(pr) && pr >= 0) {
                  add('custom_piece_label[]', lab);
                  add('custom_piece_price[]', String(pr));
                }
              });
            }
          } catch(_e){}
        }
        document.body.appendChild(form);
        // Nettoyer le brouillon pour éviter de re-proposer
        localStorage.removeItem('devisDraft');
        localStorage.removeItem('clientDraft');
        form.submit();
      }catch(e){
        console.error(e);
        alert('Impossible de créer le ticket depuis le brouillon.');
      }
    }
    // Auto-création automatique seulement si autostart=1 et qu'un brouillon contient des lignes
    (function(){
      try{
        const params = new URLSearchParams(window.location.search || '');
        if (params.get('autostart') === '1') {
          const raw = localStorage.getItem('devisDraft');
          if (raw) {
            const d = JSON.parse(raw);
            let hasLines = Array.isArray(d?.rows) && d.rows.some(r=>!!r?.checked || !!r?.pieceChecked);
            if (!hasLines && d && d.custom) {
              const validCustom = (arr) => Array.isArray(arr) && arr.some(x => ((x?.label || '').trim() !== '') && Number.isFinite(Number(String(x?.price ?? '').replace(',', '.'))) && Number(String(x?.price ?? '').replace(',', '.')) >= 0);
              if (validCustom(d.custom.prest) || validCustom(d.custom.piece)) { hasLines = true; }
            }
            if (hasLines) {
              createTicketFromDraft({{ client.id }});
            }
          }
        }
      }catch(e){}
    })();
  </script>

  <script>
    // Toast "Facturation effectuée" si ?invoiced=1
    (function(){
      try{
        const u = new URL(window.location.href);
        if (u.searchParams.get('invoiced') === '1') {
          const t = document.createElement('div');
          t.className = 'toast';
          t.textContent = 'Facturation validée ✓';
          document.body.appendChild(t);
          setTimeout(()=>{ t.remove(); }, 5000);
        }
      }catch(_e){}
    })();
  </script>

  <script>
    // Re-crée un ticket automatiquement à partir du brouillon issu du Catalogue
    function createTicketFromDraft(clientId){
      try{
        const raw = localStorage.getItem('devisDraft');
        const draft = raw ? JSON.parse(raw) : null;
        if (!draft) {
          alert('Aucun brouillon de devis trouvé.');
          return;
        }
        // Construire un formulaire POST caché vers /tickets/0/edit
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '/tickets/0/edit';

        const add = (n,v) => { const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i); };

        add('client_id', String(clientId));
        // Passer le modèle depuis l'URL si présent (ex: ?bike_model=Rockrider%20540)
        try {
          const u = new URL(window.location.href);
          const bm = u.searchParams.get('bike_model');
          if (bm) { add('bike_model', bm); }
        } catch(_e){}
        if (Array.isArray(draft.rows)) {
          draft.rows.forEach(r=>{
            // On ne pousse que si coche MO ou Pièce
            if (r.checked || r.pieceChecked) {
              add('prest_id[]', r.id || '');
              add('qty[]', r.moQty || '1');
              add('price_override[]', r.moInput || '');
              add('piece_qty[]', r.pieceQty || '0');
              add('piece_price_override[]', r.pieceInput || '');
            }
          });
        }
        // Lignes personnalisées "Prestation"/"Pièce" depuis la tuile Prestation
        if (draft && draft.custom) {
          try {
            if (Array.isArray(draft.custom.prest)) {
              draft.custom.prest.forEach(l => {
                const lab = (l?.label || '').trim();
                const pr = Number(String(l?.price ?? '').replace(',', '.'));
                if (lab !== '' && Number.isFinite(pr) && pr >= 0) {
                  add('custom_prest_label[]', lab);
                  add('custom_prest_price[]', String(pr));
                }
              });
            }
            if (Array.isArray(draft.custom.piece)) {
              draft.custom.piece.forEach(l => {
                const lab = (l?.label || '').trim();
                const pr = Number(String(l?.price ?? '').replace(',', '.'));
                if (lab !== '' && Number.isFinite(pr) && pr >= 0) {
                  add('custom_piece_label[]', lab);
                  add('custom_piece_price[]', String(pr));
                }
              });
            }
          } catch(_e){}
        }
        document.body.appendChild(form);
        // Nettoyer le brouillon pour éviter de re-proposer
        localStorage.removeItem('devisDraft');
        localStorage.removeItem('clientDraft');
        form.submit();
      }catch(e){
        console.error(e);
        alert('Impossible de créer le ticket depuis le brouillon.');
      }
    }

    // Auto-création du ticket si ?autostart=1 est présent (retour depuis /catalogue)
    (function(){
      try{
        const params = new URLSearchParams(window.location.search || '');
        if (params.get('autostart') === '1') {
          const raw = localStorage.getItem('devisDraft');
          if (raw) {
            const d = JSON.parse(raw);
            let hasLines = Array.isArray(d?.rows) && d.rows.some(r=>!!r?.checked || !!r?.pieceChecked);
            if (!hasLines && d && d.custom) {
              const validCustom = (arr) => Array.isArray(arr) && arr.some(x => ((x?.label || '').trim() !== '') && Number.isFinite(Number(String(x?.price ?? '').replace(',', '.'))) && Number(String(x?.price ?? '').replace(',', '.')) >= 0);
              if (validCustom(d.custom.prest) || validCustom(d.custom.piece)) { hasLines = true; }
            }
            if (hasLines) {
              createTicketFromDraft({{ client.id }});
            }
          }
        }
      }catch(e){}
    })();
  </script>
{% endblock %}
