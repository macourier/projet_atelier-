{% extends 'layout.twig' %}

{% block title %}Ticket — {{ ticket.id|default('Nouveau') }}{% endblock %}

{% block content %}
  <div class="flex" style="justify-content:space-between; align-items:center; margin:0 0 8px;">
    <h2 class="page-title-inside" style="margin:0;">Ticket {{ ticket.id|default('—') }}</h2>
    <div class="received-at" style="font-weight:600;">Date de réception&nbsp;: {{ (ticket.received_at|default('now'))|date('d/m/Y H:i') }}</div>
  </div>

    {% if client %}
    <div class="flex" style="gap:8px; align-items:stretch; margin:8px 0;">
      <div class="card client-card client-card-narrow" style="background:#f9fafb; border:1px solid #E5E7EB; border-radius:14px; box-shadow:0 1px 3px rgba(0,0,0,.05); padding:12px 14px; line-height:1.45; font-size:.95rem; position:relative; overflow:visible;">
        <div class="client-row"><span class="client-label">Nom:</span> {{ client.name|default('') }}</div>
        <div class="client-row"><span class="client-label">Email:</span> {{ client.email|default('') }}</div>
        <div class="client-row"><span class="client-label">Téléphone:</span> {{ client.phone|default('') }}</div>
      </div>
      <div class="card client-card client-card-narrow" x-data="{ openNote: false, noteDraft: '{{ client.note|e('js') }}' }" x-effect="if(openNote){ $nextTick(()=>{ if($refs.noteTextarea){ $refs.noteTextarea.focus(); const v=$refs.noteTextarea.value; $refs.noteTextarea.setSelectionRange(v.length, v.length); } }); }" style="background:#f1f3f5; border:none; border-radius:14px; box-shadow:none; padding:12px 14px; line-height:1.45; font-size:.95rem; position:relative; overflow:visible;">
        <div class="note-card-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
          <span class="note-title" style="font-weight:600; font-size:14px; color:#111827;">Note</span>
          <button type="button" class="note-edit-btn" aria-label="Modifier la note" @click.stop="openNote = true" onclick="try{if(!window.Alpine){var c=this.closest('.client-card');var f=c&&c.querySelector('form.note-form');var d=c&&c.querySelector('.note-display');if(f){f.style.display='block';f.style.position='absolute';f.style.top='0';f.style.left='0';f.style.right='0';f.style.zIndex='100';var ta=f.querySelector('textarea[name=\'note\']');if(ta){ta.focus();try{var v=ta.value;ta.setSelectionRange(v.length,v.length);}catch(e){}}}if(d){d.style.display='none';}}}catch(e){}" style="border:none; background:transparent; padding:4px; border-radius:999px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <img src="/img/crayon-de-couleur.png" alt="" style="width:14px;height:14px; display:block; filter:grayscale(100%); opacity:.8;">
          </button>
        </div>
        <div class="note-display" x-show="!openNote" {% if client.note is empty %}data-empty="true"{% endif %} style="font-size:13px; line-height:1.5; color:#374151; word-break:break-word;">
          {% if client.note %}
            <p class="note-text" style="margin:0;">{{ client.note }}</p>
          {% else %}
            <p class="note-placeholder" style="margin:0; color:#9CA3AF; font-style:italic;">Aucune note pour l’instant.</p>
          {% endif %}
        </div>
        <form class="note-form" method="post" action="/clients/{{ client.id }}/edit" x-show="openNote" x-transition.opacity @keydown.escape.window="openNote=false" style="display:none; position:absolute; top:0; left:0; right:0; background:#ffffff; border:1px solid #E5E7EB; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.12); padding:12px; z-index:1000;">
          <input type="hidden" name="return" value="/tickets/{{ ticket ? ticket.id : 0 }}/edit">
          {# Préserver les champs client pour éviter d'écraser les données lors de l'update #}
          <input type="hidden" name="name" value="{{ client.name|default('') }}">
          <input type="hidden" name="address" value="{{ client.address|default('') }}">
          <input type="hidden" name="email" value="{{ client.email|default('') }}">
          <input type="hidden" name="phone" value="{{ client.phone|default('') }}">
          <div>
            <textarea name="note" class="note-textarea" x-ref="noteTextarea" x-model="noteDraft" style="width:100%; min-height:100px; border-radius:8px; border:1px solid #D1D5DB; padding:8px 10px; font-size:13px; resize:vertical;">{{ client.note }}</textarea>
          </div>
          <div class="note-form-actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <button type="submit" class="btn-primary btn-note-save">Enregistrer</button>
            <button type="button" class="btn-secondary btn-note-cancel" @click.prevent="openNote=false">Annuler</button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

  <style>
    /* Recap tables shared layout to align numeric columns */
    .recap-table { width:100%; border-collapse: collapse; margin-bottom:12px; }
    .recap-table th, .recap-table td { padding:6px 8px; border-bottom:1px solid #e5e7eb; vertical-align:middle; }
    .recap-table th { text-align:left; font-weight:700; background:transparent; }
    .recap-table td { text-align:left; }
    .recap-table th:nth-child(2), .recap-table td:nth-child(2) { text-align:center; width:80px; }
    .recap-table th:nth-child(3), .recap-table td:nth-child(3) { text-align:right; width:120px; }
    .recap-table th:nth-child(4), .recap-table td:nth-child(4) { text-align:right; width:120px; }
    
    /* Cartes dans les tuiles (fond gris très pâle) */
    .category .row-card {
      background: #FAFAFA;
      border: 1px solid #E5E5E5;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    
    /* Carte cochée en bleu pâle */
    .category .row-card.checked {
      background: #F0F6FF;
      border-color: #D6E4FF;
    }
    
    /* Masquer les flèches des inputs numériques (seulement pour .price-input) */
    input.price-input[type=number]::-webkit-outer-spin-button,
    input.price-input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input.price-input[type=number] {
      -moz-appearance: textfield;
      appearance: textfield;
      height: 20px;
      min-height: 20px;
      line-height: 20px;
      font-size: .8rem;
      padding: 0 .35rem;
    }
    
    /* Ligne MO/Pièce structurée */
    .line-mo-piece {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      min-height: 32px;
    }
    
    /* Zone gauche: label */
    .line-mo-piece .zone-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1 1 auto;
      min-width: 0;
    }
    
    /* Zone droite: icônes */
    .line-mo-piece .zone-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 0 0 auto;
      min-width: 120px;
      justify-content: flex-end;
    }
    
    /* Select quantité compact (UI PC) */
    .qty-compact {
      width: 52px;
      height: 26px;
      padding: 0 6px;
      font-size: .8rem;
      border-radius: 6px;
      border: 1px solid #D1D5DB;
      background-color: #FFFFFF;
      color: #111827;
      text-align: center;
      appearance: none;
    }

    .qty-compact:focus {
      outline: none;
      border-color: #93C5FD;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
    }

    .qty-label {
      font-size: .7rem;
      color: #9CA3AF;
      margin: 0 4px;
      white-space: nowrap;
    }

    .mo-label {
      font-size: .9rem;
      font-weight: 700;
      color: #111827;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.06);
    }

    .mo-price {
      font-size: .9rem;
      font-weight: 600;
      color: #111827;
      margin-left: 6px;
    }

    .piece-label {
      display: inline-block;
      max-width: 18ch;
      font-size: .9rem;
      font-weight: 600;
      color: #111827;
      line-height: 1.3;
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
      max-height: calc(1.3em * 2);
      overflow: hidden;
    }

    .piece-price {
      font-size: .85rem;
      font-weight: 600;
      color: #111827;
      margin-left: 6px;
      white-space: nowrap;
    }

    .prestation .label .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .presta-title {
      font-weight: 600;
      color: #111827;
    }

    .mo-header {
      font-size: .85rem;
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
    }
    
    /* Icônes inline sans encadrement */
    .icon-inline {
      background: transparent;
      border: none;
      padding: 2px;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s ease, transform 0.1s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .icon-inline:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    .icon-inline:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .icon-inline img {
      width: 16px;
      height: 16px;
      vertical-align: middle;
    }
  </style>


  <form method="post" action="/tickets/{{ ticket ? ticket.id : 0 }}/edit" x-data="ticketForm()" x-init="debouncedRecalc()" @change="debouncedRecalc()" @input="debouncedRecalc()">

    {% if client %}
      <input type="hidden" name="client_id" value="{{ client.id }}">
    {% endif %}
    <div id="pending-hidden" style="display:none"></div>

    <input type="hidden" name="received_at" value="{{ (ticket.received_at|default('now'))|date('Y-m-d\\TH:i') }}">

    {% if not ticket %}
    <fieldset class="form-field">
      <legend style="font-weight:600;">Vélo</legend>
      <div class="form-field">
        <label for="bike_model">Modèle</label>
        <input id="bike_model" name="bike_model" type="text" value="{{ ticket.bike_model|default(client.bike_model|default('')) }}" placeholder="Ex: Rockrider 540">
      </div>
      <div class="form-field">
        <label for="bike_notes">Notes</label>
        <textarea id="bike_notes" name="bike_notes" rows="2">{{ ticket.bike_notes|default('') }}</textarea>
      </div>
    </fieldset>
    {% else %}
    <div class="form-field">
      <strong>Vélo :</strong> {{ ticket.bike_model|default(client.bike_model|default('—')) }}
    </div>
    {% endif %}

    <div id="catalogue" x-show="showCatalogue" x-transition.opacity x-transition.duration.250ms style="transform-origin: top;">
      <h2 style="margin:16px 0 8px;">Catalogue</h2>

    {# Accordéons par catégorie #}
    {% set tvadef = env.TVA_DEFAULT|default(20) %}
    <div x-data="{ openCat: null }">
    {% for cat, items in catalogue|default({}) %}
      <div class="category" x-data="{ id: '{{ cat|e('js') }}' }" :class="{ 'open': openCat === id }">
        <div class="category-header"
             role="button"
             tabindex="0"
             :aria-expanded="openCat === id ? 'true' : 'false'"
             @click="openCat = (openCat === id ? null : id); $nextTick(() => { $el.scrollIntoView({ behavior: 'smooth', block: 'start' }); })"
             @keydown.enter.prevent="openCat = (openCat === id ? null : id)"
             @keydown.space.prevent="openCat = (openCat === id ? null : id)">
          <div style="font-weight:700; display:flex; align-items:center; gap:.5rem;">
            {{ cat }}
          </div>
        </div>
        <template x-if="openCat === id"><div class="prestations">
          {% for item in items %}
            <div class="prestation row-card" data-id="{{ item.id }}"
                 :class="{ 'checked': checked || pieceChecked }"
                 x-data="{
                    checked:false, pieceChecked:false, 
                    moQty:1, pieceQty:1, 
                    moBase:0, pieceBase:0, 
                    moEdit:false, pieceEdit:false, 
                    moInput:'', pieceInput:'',
                    pieceLabel:'',
                    fmt(n){ return Number(n).toFixed(2); },
                    moFinal(){ return this.moInput!=='' && !isNaN(+this.moInput) ? +this.moInput : this.moBase; },
                    pieceFinal(){ return this.pieceInput!=='' && !isNaN(+this.pieceInput) ? +this.pieceInput : this.pieceBase; },
                    moValid(){ return this.moInput!=='' && !isNaN(+this.moInput); },
                    pieceValid(){ return this.pieceInput!=='' && !isNaN(+this.pieceInput); },
                    resetMo(){ this.moInput=''; this.moQty=1; },
                    resetPiece(){ this.pieceInput=''; this.pieceQty=1; },
                    sanitizePrice(val){
                      let s = String(val ?? '').replace(',', '.').replace(/[^\d.]/g, '');
                      let num = parseFloat(s);
                      if (isNaN(num) || num < 0) return '';
                      if (num > 9999) num = 9999;
                      return num.toString().slice(0, 7);
                    }
                 }"
                 x-init="moBase=parseFloat($el.dataset.price)||0; pieceBase=parseFloat($el.dataset.piecePrice)||0; baseTva=parseFloat($el.dataset.tva)||20; pieceLabel=($el.dataset.pieceLabel || 'Pièce').slice(0, 19)"
                 data-price="{{ item.prix_main_oeuvre_ht|default(0) }}"
                 data-tva="{{ item.tva_pct|default(tvadef) }}"
                 data-piece-price="{{ item.piece_prix_ht|default(0) }}"
                 data-piece-label="{{ item.piece_libelle|default('Pièce') }}">
              <input type="checkbox" class="round prest-check" style="width:20px;height:20px"
                      x-model="checked" @change="if($el.checked){ pieceChecked = true; } $root.recalc()">
              <div class="label">
                <div class="title-row">
                  <span class="presta-title">{{ item.libelle }}</span>
                  <span class="mo-header" x-text="'MO : ' + fmt(moFinal()) + ' €'">
                    {{ (item.prix_main_oeuvre_ht|default(0))|number_format(2, ',', ' ') }} €
                  </span>
                </div>
              </div>

              <input type="hidden" name="prest_id[]" value="{{ item.id }}" :disabled="!checked">

              <div class="row-body" style="display:flex; flex-direction:column; gap:10px;">
                <!-- Ligne Main d'œuvre -->
                <div class="line-mo-piece">
                  <div class="zone-left">
                    <span class="mo-label">MO :</span>

                    <span class="mo-price" x-text="Number(moFinal() || 0).toFixed(2) + ' €'">
                      {{ (item.prix_main_oeuvre_ht|default(0))|number_format(2, ',', ' ') }} €
                    </span>

                    <span class="qty-label">Qté</span>
                    <select name="qty[]" :disabled="!checked" x-model="moQty" @change="$root.recalc()" class="qty-compact">
                      <option value="1">1</option>
                      <option value="2">2</option>
                    </select>
                  </div>

                  <div class="zone-right">
                    <div x-show="!moEdit" style="display:flex; align-items:center; gap:4px;">
                      <button type="button" :disabled="!checked" @click="moEdit=true" x-transition title="Modifier le prix MO" class="icon-inline">
                        <img src="/img/crayon-de-couleur.png" alt="Modifier">
                      </button>
                      <button type="button" title="Réinitialiser MO" x-show="moInput!==''" x-transition @click="resetMo(); $root.recalc()" class="icon-inline">
                        <img src="/img/annuler.png" alt="Réinitialiser">
                      </button>
                    </div>
                    <div x-show="moEdit" x-transition style="display:flex; align-items:center; gap:4px;">
                      <input type="number" step="0.01" min="0" max="9999" inputmode="decimal" placeholder="Prix HT" :disabled="!checked" class="price-input"
                             x-model="moInput" @input="moInput = sanitizePrice(moInput); $root.recalc()" 
                             style="width:75px; padding:3px 6px; font-size:.85rem; border:1px solid #3b82f6; border-radius:4px;">
                      <button type="button" x-show="moValid()" @click="if(moValid()){ moEdit=false; $root.recalc(); }" x-transition
                              style="padding:3px 8px; font-size:.8rem; background:#3b82f6; color:#fff; border:none; border-radius:4px; cursor:pointer;">✓</button>
                    </div>
                  </div>
                </div>

                <!-- Ligne Pièce -->
                <div class="line-mo-piece">
                  <div class="zone-left" style="gap:10px;">
                    <input type="checkbox" class="round piece-check" style="width:16px;height:16px; margin-right:4px;" x-model="pieceChecked" @change="$root.recalc()">
                    <span class="piece-label" x-text="pieceLabel">
                      {{ item.piece_libelle|default('Pièce') }}
                    </span>

                    <span class="piece-price" x-text="Number(pieceFinal() || 0).toFixed(2) + ' €'">
                      {{ (item.piece_prix_ht|default(0))|number_format(2, ',', ' ') }} €
                    </span>

                    <span class="qty-label">Qté</span>
                    <select name="piece_qty[]" :disabled="!pieceChecked" x-model="pieceQty" @change="$root.recalc()" class="qty-compact">
                      <option value="1">1</option>
                      <option value="2">2</option>
                    </select>
                  </div>

                  <div class="zone-right">
                    <div x-show="!pieceEdit" style="display:flex; align-items:center; gap:4px;">
                      <button type="button" :disabled="!pieceChecked" @click="pieceEdit=true" x-transition title="Modifier le prix Pièce" class="icon-inline">
                        <img src="/img/crayon-de-couleur.png" alt="Modifier">
                      </button>
                      <button type="button" title="Réinitialiser Pièce" x-show="pieceInput!==''" x-transition @click="resetPiece(); $root.recalc()" class="icon-inline">
                        <img src="/img/annuler.png" alt="Réinitialiser">
                      </button>
                    </div>
                    <div x-show="pieceEdit" x-transition style="display:flex; align-items:center; gap:4px;">
                      <input type="number" step="0.01" min="0" max="9999" inputmode="decimal" placeholder="Prix HT" :disabled="!pieceChecked" class="price-input"
                             x-model="pieceInput" @input="pieceInput = sanitizePrice(pieceInput); $root.recalc()" 
                             style="width:75px; padding:3px 6px; font-size:.85rem; border:1px solid #3b82f6; border-radius:4px;">
                      <button type="button" x-show="pieceValid()" @click="if(pieceValid()){ pieceEdit=false; $root.recalc(); }" x-transition
                              style="padding:3px 8px; font-size:.8rem; background:#3b82f6; color:#fff; border:none; border-radius:4px; cursor:pointer;">✓</button>
                    </div>
                  </div>
                </div>

                <!-- Inputs masqués pour POST (persistance) -->
                <input type="hidden" name="price_override[]" :value="moInput" :disabled="!checked">
                <input type="hidden" name="piece_price_override[]" :value="pieceInput" :disabled="!pieceChecked">
              </div>
            </div>
          {% endfor %}
        </div></template>
      </div>
    {% else %}
      <p class="text-muted">Le catalogue est vide. Allez dans Administration → Prestations pour le remplir.</p>
    {% endfor %}

    <!-- Tuile spéciale: Vente de vélo (toujours en dernier) -->
    <div class="category" x-data="{ id: '_bike_sale' }" :class="{ 'open': openCat === id }" data-cat="_bike_sale">
      <div class="category-header"
           role="button"
           tabindex="0"
           :aria-expanded="openCat === id ? 'true' : 'false'"
           @click="openCat = (openCat === id ? null : id); $nextTick(() => { $el.scrollIntoView({ behavior: 'smooth', block: 'start' }); })"
           @keydown.enter.prevent="openCat = (openCat === id ? null : id)"
           @keydown.space.prevent="openCat = (openCat === id ? null : id)">
          <div style="font-weight:700; display:flex; align-items:center; gap:.5rem;">
            Vente de vélo
          </div>
      </div>
      <template x-if="openCat === id"><div class="prestations">
        <div class="row-card" style="display:flex; flex-direction:column; gap:8px;">
          <div>
            <label>Modèle du vélo</label>
            <input id="bike-sale-model" type="text" class="input" placeholder="Ex: Rockrider 540">
          </div>
          <div>
            <label>Prix du vélo</label>
            <input id="bike-sale-price" type="number" step="0.01" inputmode="decimal" class="input" placeholder="0.00">
          </div>
          <div>
            <button type="button" class="btn btn-secondary btn-add-bike-sale">Ajouter</button>
          </div>
        </div>
      </div></template>
    </div>

    </div>
    </div>

    {# Récapitulatif et nouveaux éléments #}
    {% include 'components/catalogue_recap.twig' %}
    
    {% include 'components/recap_table.twig' with {
      mode: 'ticket',
      prestations: prestations,
      consommables: consommables,
      ticket: ticket,
      client: client,
      totaux: totaux
    } %}
  </form>

  {% include 'components/pave_numerique.twig' %}

  {% include 'components/ticket_form_js.twig' %}
  <script>
    // Fallback minimal si Alpine n'est pas disponible (bloqué par le navigateur)
    (function(){
      if (window.Alpine) return; // Alpine présent, ne rien faire
      try {
        var root = document;
        // Ouvrir l'éditeur au clic sur le crayon
        root.addEventListener('click', function(e){
          var btn = e.target && e.target.closest ? e.target.closest('.note-edit-btn') : null;
          if (!btn) return;
          e.preventDefault();
          var card = btn.closest('.client-card');
          if (!card) return;
          var form = card.querySelector('form.note-form');
          var display = card.querySelector('.note-display');
          if (form) {
            form.style.display = 'block';
            form.style.position = 'absolute';
            form.style.top = '0';
            form.style.left = '0';
            form.style.right = '0';
            form.style.zIndex = '100';
            var ta = form.querySelector('textarea[name="note"]');
            if (ta) { ta.focus(); try { var v=ta.value; ta.setSelectionRange(v.length, v.length); } catch(_){} }
          }
          if (display) display.style.display = 'none';
        }, false);

        // Bouton Annuler
        root.addEventListener('click', function(e){
          var cancel = e.target && e.target.closest ? e.target.closest('.btn-note-cancel') : null;
          if (!cancel) return;
          e.preventDefault();
          var form = cancel.closest('form.note-form');
          var card = cancel.closest('.client-card');
          var display = card ? card.querySelector('.note-display') : null;
          if (form) form.style.display = 'none';
          if (display) display.style.display = '';
        }, false);

        // Echap pour fermer
        root.addEventListener('keydown', function(e){
          if (e.key !== 'Escape') return;
          var openForm = document.querySelector('form.note-form[style*="display: block"]');
          if (!openForm) return;
          e.preventDefault();
          var card = openForm.closest('.client-card');
          var display = card ? card.querySelector('.note-display') : null;
          openForm.style.display = 'none';
          if (display) display.style.display = '';
        }, false);
      } catch(_){}
    })();
  </script>
{% endblock %}
