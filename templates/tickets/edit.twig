{% extends 'layout.twig' %}

{% block title %}Ticket — {{ ticket.id|default('Nouveau') }}{% endblock %}

{% block content %}
  <div class="flex" style="justify-content:space-between; align-items:center; margin:0 0 8px;">
    <h2 class="page-title-inside" style="margin:0;">Ticket {{ ticket.id|default('—') }}</h2>
    <div class="received-at" style="font-weight:600;">Date de réception&nbsp;: {{ (ticket.received_at|default('now'))|date('d/m/Y H:i') }}</div>
  </div>

    {% if client %}
    <div class="flex" style="gap:8px; align-items:stretch; margin:8px 0;">
      <div class="card client-card client-card-narrow" style="background:#f9fafb; border:1px solid #E5E7EB; border-radius:14px; box-shadow:0 1px 3px rgba(0,0,0,.05); padding:12px 14px; line-height:1.45; font-size:.95rem; position:relative; overflow:visible;">
        <div class="client-row"><span class="client-label">Nom:</span> {{ client.name|default('') }}</div>
        <div class="client-row"><span class="client-label">Email:</span> {{ client.email|default('') }}</div>
        <div class="client-row"><span class="client-label">Téléphone:</span> {{ client.phone|default('') }}</div>
      </div>
      <div class="card client-card client-card-narrow" x-data="{ openNote: false, noteDraft: '{{ client.note|e('js') }}' }" x-effect="if(openNote){ $nextTick(()=>{ if($refs.noteTextarea){ $refs.noteTextarea.focus(); const v=$refs.noteTextarea.value; $refs.noteTextarea.setSelectionRange(v.length, v.length); } }); }" style="background:#f1f3f5; border:none; border-radius:14px; box-shadow:none; padding:12px 14px; line-height:1.45; font-size:.95rem; position:relative; overflow:visible;">
        <div class="note-card-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
          <span class="note-title" style="font-weight:600; font-size:14px; color:#111827;">Note</span>
          <button type="button" class="note-edit-btn" aria-label="Modifier la note" @click.stop="openNote = true" onclick="try{if(!window.Alpine){var c=this.closest('.client-card');var f=c&&c.querySelector('form.note-form');var d=c&&c.querySelector('.note-display');if(f){f.style.display='block';f.style.position='absolute';f.style.top='0';f.style.left='0';f.style.right='0';f.style.zIndex='100';var ta=f.querySelector('textarea[name=\'note\']');if(ta){ta.focus();try{var v=ta.value;ta.setSelectionRange(v.length,v.length);}catch(e){}}}if(d){d.style.display='none';}}}catch(e){}" style="border:none; background:transparent; padding:4px; border-radius:999px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <img src="/img/crayon-de-couleur.png" alt="" style="width:14px;height:14px; display:block; filter:grayscale(100%); opacity:.8;">
          </button>
        </div>
        <div class="note-display" x-show="!openNote" {% if client.note is empty %}data-empty="true"{% endif %} style="font-size:13px; line-height:1.5; color:#374151; word-break:break-word;">
          {% if client.note %}
            <p class="note-text" style="margin:0;">{{ client.note }}</p>
          {% else %}
            <p class="note-placeholder" style="margin:0; color:#9CA3AF; font-style:italic;">Aucune note pour l’instant.</p>
          {% endif %}
        </div>
        <form class="note-form" method="post" action="/clients/{{ client.id }}/edit" x-show="openNote" x-transition.opacity @keydown.escape.window="openNote=false" style="display:none; position:absolute; top:0; left:0; right:0; background:#ffffff; border:1px solid #E5E7EB; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.12); padding:12px; z-index:1000;">
          <input type="hidden" name="return" value="/tickets/{{ ticket ? ticket.id : 0 }}/edit">
          {# Préserver les champs client pour éviter d'écraser les données lors de l'update #}
          <input type="hidden" name="name" value="{{ client.name|default('') }}">
          <input type="hidden" name="address" value="{{ client.address|default('') }}">
          <input type="hidden" name="email" value="{{ client.email|default('') }}">
          <input type="hidden" name="phone" value="{{ client.phone|default('') }}">
          <div>
            <textarea name="note" class="note-textarea" x-ref="noteTextarea" x-model="noteDraft" style="width:100%; min-height:100px; border-radius:8px; border:1px solid #D1D5DB; padding:8px 10px; font-size:13px; resize:vertical;">{{ client.note }}</textarea>
          </div>
          <div class="note-form-actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <button type="submit" class="btn-primary btn-note-save">Enregistrer</button>
            <button type="button" class="btn-secondary btn-note-cancel" @click.prevent="openNote=false">Annuler</button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

  <style>
    /* Recap tables shared layout to align numeric columns */
    .recap-table { width:100%; border-collapse: collapse; margin-bottom:12px; }
    .recap-table th, .recap-table td { padding:6px 8px; border-bottom:1px solid #e5e7eb; vertical-align:middle; }
    .recap-table th { text-align:left; font-weight:700; background:transparent; }
    .recap-table td { text-align:left; }
    .recap-table th:nth-child(2), .recap-table td:nth-child(2) { text-align:center; width:80px; }
    .recap-table th:nth-child(3), .recap-table td:nth-child(3) { text-align:right; width:120px; }
    .recap-table th:nth-child(4), .recap-table td:nth-child(4) { text-align:right; width:120px; }
  </style>


  <form method="post" action="/tickets/{{ ticket ? ticket.id : 0 }}/edit" x-data="ticketForm()" x-init="debouncedRecalc()" @change="debouncedRecalc()" @input="debouncedRecalc()">

    {% if client %}
      <input type="hidden" name="client_id" value="{{ client.id }}">
    {% endif %}
    <div id="pending-hidden" style="display:none"></div>

    <input type="hidden" name="received_at" value="{{ (ticket.received_at|default('now'))|date('Y-m-d\\TH:i') }}">

    {% if not ticket %}
    <fieldset class="form-field">
      <legend style="font-weight:600;">Vélo</legend>
      <div class="form-field">
        <label for="bike_model">Modèle</label>
        <input id="bike_model" name="bike_model" type="text" value="{{ ticket.bike_model|default(client.bike_model|default('')) }}" placeholder="Ex: Rockrider 540">
      </div>
      <div class="form-field">
        <label for="bike_notes">Notes</label>
        <textarea id="bike_notes" name="bike_notes" rows="2">{{ ticket.bike_notes|default('') }}</textarea>
      </div>
    </fieldset>
    {% else %}
    <div class="form-field">
      <strong>Vélo :</strong> {{ ticket.bike_model|default(client.bike_model|default('—')) }}
    </div>
    {% endif %}

    <div id="catalogue" x-show="showCatalogue" x-transition.opacity x-transition.duration.250ms style="transform-origin: top;">
      <h2 style="margin:16px 0 8px;">Catalogue</h2>

    {# Accordéons par catégorie #}
    {% set tvadef = env.TVA_DEFAULT|default(20) %}
    <div x-data="{ openCat: null }">
    {% for cat, items in catalogue|default({}) %}
      <div class="category" x-data="{ id: '{{ cat|e('js') }}' }" :class="{ 'open': openCat === id }">
        <div class="category-header"
             role="button"
             tabindex="0"
             :aria-expanded="openCat === id ? 'true' : 'false'"
             @click="openCat = (openCat === id ? null : id); $nextTick(() => { $el.scrollIntoView({ behavior: 'smooth', block: 'start' }); })"
             @keydown.enter.prevent="openCat = (openCat === id ? null : id)"
             @keydown.space.prevent="openCat = (openCat === id ? null : id)">
          <div style="font-weight:700; display:flex; align-items:center; gap:.5rem;">
            {{ cat }}
          </div>
        </div>
        <template x-if="openCat === id"><div class="prestations">
          {% for item in items %}
            <div class="prestation row-card" x-data="{ 
                    checked:false, pieceChecked:false, 
                    moQty:1, pieceQty:1, 
                    moBase:0, pieceBase:0, 
                    moEdit:false, pieceEdit:false, 
                    moInput:'', pieceInput:'',
                    moFinal(){ return this.moInput!=='' && !isNaN(+this.moInput) ? +this.moInput : this.moBase; },
                    pieceFinal(){ return this.pieceInput!=='' && !isNaN(+this.pieceInput) ? +this.pieceInput : this.pieceBase; },
                    moValid(){ return this.moInput!=='' && !isNaN(+this.moInput); },
                    pieceValid(){ return this.pieceInput!=='' && !isNaN(+this.pieceInput); },
                    resetMo(){ this.moInput=''; this.moQty=1; },
                    resetPiece(){ this.pieceInput=''; this.pieceQty=1; }
                 }"
                 x-init="moBase=parseFloat($el.dataset.price)||0; pieceBase=parseFloat($el.dataset.piecePrice)||0; baseTva=parseFloat($el.dataset.tva)||20"
                 data-price="{{ item.prix_main_oeuvre_ht|default(0) }}"
                 data-tva="{{ item.tva_pct|default(tvadef) }}"
                 data-piece-price="{{ item.piece_prix_ht|default(0) }}"
                 data-piece-label="{{ item.piece_libelle|default('Pièce') }}">
              <input type="checkbox" class="round prest-check" style="width:20px;height:20px"
                     x-model="checked" @change="if($el.checked){ pieceChecked = true; } $root.recalc()">
              <div class="label">
                <div style="font-weight:600">{{ item.libelle }}</div>
              </div>

              <input type="hidden" name="prest_id[]" value="{{ item.id }}" :disabled="!checked">

              <div class="row-body">
                <!-- Main d’œuvre -->
                <div>
                  <div class="text-muted section-title" style="font-size:.8rem; display:flex; align-items:center; gap:8px;"><i class="fas fa-wrench"></i><span>Main d’œuvre</span></div>
                  <div class="price-lines">
                    Prix de base MO: <strong><span>{{ (item.prix_main_oeuvre_ht|default(0))|number_format(0, ',', ' ') }}</span> €</strong>
                  </div>
                  <div class="flex gap-8" style="align-items:center;">
                    <label class="text-muted" style="font-size:.8rem;">Qté</label>
                    <div class="qty-spinner" style="display:flex; align-items:center; gap:6px;">
                      <button type="button" class="btn btn-ghost btn-ghost-sm" :disabled="!checked" @click="moQty = Math.max(1, Number(moQty||1)-1); $root.debouncedRecalc()">−</button>
                      <input name="qty[]" type="number" min="1" :disabled="!checked" x-model="moQty" @input="$root.debouncedRecalc()" class="select-qty" style="width:64px">
                      <button type="button" class="btn btn-ghost btn-ghost-sm" :disabled="!checked" @click="moQty = Number(moQty||1)+1; $root.debouncedRecalc()">+</button>
                    </div>

                    <div class="flex gap-8" style="align-items:center;">
                      <button type="button" class="btn btn-ghost btn-ghost-sm price-soft" :disabled="!checked" 
                              x-show="!moEdit && moInput===''" 
                              @click="moEdit=true" x-transition>
                        Prix
                      </button>
                      <div x-show="moEdit" x-transition style="display:flex; align-items:center; gap:8px;">
                        <input type="number" step="0.01" placeholder="0.00" :disabled="!checked"
                               x-model="moInput" style="width:120px" @input="$root.recalc()">
                        <button type="button" class="btn" :class="moValid() ? 'btn-success' : 'btn-ghost btn-ghost-sm'"
                                @click="if(moValid()){ moEdit=false; $root.recalc(); }" x-transition>
                          Valider
                        </button>
                      </div>
                      <a href="javascript:void(0)" class="text-muted" style="font-size:.85rem;" 
                         x-show="moInput!==''" x-transition
                         @click="resetMo(); $root.recalc()">Réinitialiser</a>
                    </div>
                  </div>
                </div>

                <!-- Pièce -->
                <div>
                  <div class="text-muted section-title" style="font-size:.8rem; display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" class="round piece-check" style="width:18px;height:18px" x-model="pieceChecked" @change="$root.recalc()">
                    <i class="fas fa-puzzle-piece"></i><span x-text="$el.closest('.prestation')?.dataset?.pieceLabel || 'Pièce'">Pièce</span>
                  </div>
                  <div class="price-lines">
                    <template x-if="pieceInput===''">
                      <span>Prix de base Pièce: <strong x-text="$root.fmt(pieceBase)">{{ (item.piece_prix_ht|default(0))|number_format(2, '.', '') }}</strong> €</span>
                    </template>
                    <template x-if="pieceInput!==''">
                      <span>Prix <span style="padding:0 6px; border-radius:6px; background:#fffbeb; color:#92400e; font-weight:600;">modifié</span>: <strong x-text="$root.fmt(pieceFinal())"></strong> €</span>
                      <span class="text-muted" style="margin-left:6px;">(Prix de base Pièce: <span x-text="$root.fmt(pieceBase)"></span> €)</span>
                    </template>
                  </div>
                  <div class="flex gap-8" style="align-items:center; margin-top:6px;">
                    <label class="text-muted" style="font-size:.8rem;">Qté</label>
                    <div class="qty-spinner" style="display:flex; align-items:center; gap:6px;">
                      <button type="button" class="btn btn-ghost btn-ghost-sm" :disabled="!pieceChecked" @click="pieceQty = Math.max(1, Number(pieceQty||1)-1); $root.debouncedRecalc()">−</button>
                      <input name="piece_qty[]" type="number" min="1" :disabled="!pieceChecked" x-model="pieceQty" @input="$root.debouncedRecalc()" class="select-qty" style="width:64px">
                      <button type="button" class="btn btn-ghost btn-ghost-sm" :disabled="!pieceChecked" @click="pieceQty = Number(pieceQty||1)+1; $root.debouncedRecalc()">+</button>
                    </div>

                    <div class="flex gap-8" style="align-items:center;">
                      <button type="button" class="btn btn-ghost btn-ghost-sm price-soft" :disabled="!pieceChecked" 
                              x-show="!pieceEdit && pieceInput===''" 
                              @click="pieceEdit=true" x-transition>
                        Prix
                      </button>
                      <div x-show="pieceEdit" x-transition style="display:flex; align-items:center; gap:8px;">
                        <input type="number" step="0.01" placeholder="0.00" :disabled="!pieceChecked"
                               x-model="pieceInput" style="width:120px" @input="$root.recalc()">
                        <button type="button" class="btn" :class="pieceValid() ? 'btn-success' : 'btn-ghost btn-ghost-sm'"
                                @click="if(pieceValid()){ pieceEdit=false; $root.recalc(); }" x-transition>
                          Valider
                        </button>
                      </div>
                      <a href="javascript:void(0)" class="text-muted" style="font-size:.85rem;" 
                         x-show="pieceInput!==''" x-transition
                         @click="resetPiece(); $root.recalc()">Réinitialiser</a>
                    </div>
                  </div>
                </div>

                <!-- Inputs masqués pour POST (persistance) -->
                <input type="hidden" name="price_override[]" :value="moInput" :disabled="!checked">
                <input type="hidden" name="piece_price_override[]" :value="pieceInput" :disabled="!pieceChecked">
              </div>
            </div>
          {% endfor %}
        </div></template>
      </div>
    {% else %}
      <p class="text-muted">Le catalogue est vide. Allez dans Administration → Prestations pour le remplir.</p>
    {% endfor %}

    <!-- Tuile spéciale: Vente de vélo (toujours en dernier) -->
    <div class="category" x-data="{ id: '_bike_sale' }" :class="{ 'open': openCat === id }" data-cat="_bike_sale">
      <div class="category-header"
           role="button"
           tabindex="0"
           :aria-expanded="openCat === id ? 'true' : 'false'"
           @click="openCat = (openCat === id ? null : id); $nextTick(() => { $el.scrollIntoView({ behavior: 'smooth', block: 'start' }); })"
           @keydown.enter.prevent="openCat = (openCat === id ? null : id)"
           @keydown.space.prevent="openCat = (openCat === id ? null : id)">
          <div style="font-weight:700; display:flex; align-items:center; gap:.5rem;">
            Vente de vélo
          </div>
      </div>
      <template x-if="openCat === id"><div class="prestations">
        <div class="row-card" style="display:flex; flex-direction:column; gap:8px;">
          <div>
            <label>Modèle du vélo</label>
            <input id="bike-sale-model" type="text" class="input" placeholder="Ex: Rockrider 540">
          </div>
          <div>
            <label>Prix du vélo</label>
            <input id="bike-sale-price" type="number" step="0.01" inputmode="decimal" class="input" placeholder="0.00">
          </div>
          <div>
            <button type="button" class="btn btn-secondary btn-add-bike-sale">Ajouter</button>
          </div>
        </div>
      </div></template>
    </div>

    </div>
    </div>

    {# Récapitulatif et nouveaux éléments #}
    {% include 'components/recap_table.twig' with {
      mode: 'ticket',
      prestations: prestations,
      consommables: consommables,
      ticket: ticket,
      client: client,
      totaux: totaux
    } %}
  </form>

  {% include 'components/pave_numerique.twig' %}

  {% include 'components/ticket_form_js.twig' %}
  <script>
    // Fallback minimal si Alpine n'est pas disponible (bloqué par le navigateur)
    (function(){
      if (window.Alpine) return; // Alpine présent, ne rien faire
      try {
        var root = document;
        // Ouvrir l'éditeur au clic sur le crayon
        root.addEventListener('click', function(e){
          var btn = e.target && e.target.closest ? e.target.closest('.note-edit-btn') : null;
          if (!btn) return;
          e.preventDefault();
          var card = btn.closest('.client-card');
          if (!card) return;
          var form = card.querySelector('form.note-form');
          var display = card.querySelector('.note-display');
          if (form) {
            form.style.display = 'block';
            form.style.position = 'absolute';
            form.style.top = '0';
            form.style.left = '0';
            form.style.right = '0';
            form.style.zIndex = '100';
            var ta = form.querySelector('textarea[name="note"]');
            if (ta) { ta.focus(); try { var v=ta.value; ta.setSelectionRange(v.length, v.length); } catch(_){} }
          }
          if (display) display.style.display = 'none';
        }, false);

        // Bouton Annuler
        root.addEventListener('click', function(e){
          var cancel = e.target && e.target.closest ? e.target.closest('.btn-note-cancel') : null;
          if (!cancel) return;
          e.preventDefault();
          var form = cancel.closest('form.note-form');
          var card = cancel.closest('.client-card');
          var display = card ? card.querySelector('.note-display') : null;
          if (form) form.style.display = 'none';
          if (display) display.style.display = '';
        }, false);

        // Echap pour fermer
        root.addEventListener('keydown', function(e){
          if (e.key !== 'Escape') return;
          var openForm = document.querySelector('form.note-form[style*="display: block"]');
          if (!openForm) return;
          e.preventDefault();
          var card = openForm.closest('.client-card');
          var display = card ? card.querySelector('.note-display') : null;
          openForm.style.display = 'none';
          if (display) display.style.display = '';
        }, false);
      } catch(_){}
    })();
  </script>
{% endblock %}
