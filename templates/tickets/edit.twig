{% extends 'layout.twig' %}

{% block title %}Ticket — {{ ticket.id|default('Nouveau') }}{% endblock %}

{% block content %}
  <div class="flex" style="justify-content:space-between; align-items:center; margin:0 0 8px;">
    <h2 class="page-title-inside" style="margin:0;">Ticket {{ ticket.id|default('—') }}</h2>
    <div class="received-at" style="font-weight:600;">Date de réception&nbsp;: {{ (ticket.received_at|default('now'))|date('d/m/Y H:i') }}</div>
  </div>

    {% if client %}
    <div class="flex" style="gap:8px; align-items:stretch; margin:8px 0;">
      <div class="card client-card client-card-narrow" style="background:#f9fafb; border:1px solid #E5E7EB; border-radius:14px; box-shadow:0 1px 3px rgba(0,0,0,.05); padding:12px 14px; line-height:1.45; font-size:.95rem; position:relative; overflow:visible;">
        <div class="client-row"><span class="client-label">Nom:</span> {{ client.name|default('') }}</div>
        <div class="client-row"><span class="client-label">Email:</span> {{ client.email|default('') }}</div>
        <div class="client-row"><span class="client-label">Téléphone:</span> {{ client.phone|default('') }}</div>
      </div>
      <div class="card client-card client-card-narrow" style="background:#f9fafb; border:1px solid #E5E7EB; border-radius:14px; box-shadow:0 1px 3px rgba(0,0,0,.05); padding:12px 14px; line-height:1.45; font-size:.95rem; position:relative; overflow:visible;">
        <div class="note-card-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
          <span class="note-title" style="font-weight:600; font-size:14px; color:#111827;">Note</span>
          <button type="button" class="note-edit-btn" aria-label="Modifier la note" style="border:none; background:transparent; padding:4px; border-radius:999px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <img src="/img/crayon-de-couleur.png" alt="" style="width:14px;height:14px; display:block; filter:grayscale(100%); opacity:.8;">
          </button>
        </div>
        <div class="note-display" {% if client.note is empty %}data-empty="true"{% endif %} style="font-size:13px; line-height:1.5; color:#374151; word-break:break-word;">
          {% if client.note %}
            <p class="note-text" style="margin:0;">{{ client.note }}</p>
          {% else %}
            <p class="note-placeholder" style="margin:0; color:#9CA3AF; font-style:italic;">Aucune note pour l’instant.</p>
          {% endif %}
        </div>
        <form class="note-form" method="post" action="/clients/{{ client.id }}/edit" style="display:none; position:absolute; top:0; left:0; right:0; background:#fff; border:1px solid #E5E7EB; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.12); padding:12px; z-index:30;">
          <input type="hidden" name="return" value="/tickets/{{ ticket ? ticket.id : 0 }}/edit">
          {# Préserver les champs client pour éviter d'écraser les données lors de l'update #}
          <input type="hidden" name="name" value="{{ client.name|default('') }}">
          <input type="hidden" name="address" value="{{ client.address|default('') }}">
          <input type="hidden" name="email" value="{{ client.email|default('') }}">
          <input type="hidden" name="phone" value="{{ client.phone|default('') }}">
          <div>
            <textarea name="note" class="note-textarea" style="width:100%; min-height:100px; border-radius:8px; border:1px solid #D1D5DB; padding:8px 10px; font-size:13px; resize:vertical;">{{ client.note }}</textarea>
          </div>
          <div class="note-form-actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <button type="submit" class="btn-primary btn-note-save">Enregistrer</button>
            <button type="button" class="btn-secondary btn-note-cancel">Annuler</button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

  <style>
    /* Recap tables shared layout to align numeric columns */
    .recap-table { width:100%; border-collapse: collapse; margin-bottom:12px; }
    .recap-table th, .recap-table td { padding:6px 8px; border-bottom:1px solid #e5e7eb; vertical-align:middle; }
    .recap-table th { text-align:left; font-weight:700; background:transparent; }
    .recap-table td { text-align:left; }
    .recap-table th:nth-child(2), .recap-table td:nth-child(2) { text-align:center; width:80px; }
    .recap-table th:nth-child(3), .recap-table td:nth-child(3) { text-align:right; width:120px; }
    .recap-table th:nth-child(4), .recap-table td:nth-child(4) { text-align:right; width:120px; }
  </style>


  <form method="post" action="/tickets/{{ ticket ? ticket.id : 0 }}/edit" x-data="ticketForm()" x-init="debouncedRecalc()" @change="debouncedRecalc()" @input="debouncedRecalc()">

    {% if client %}
      <input type="hidden" name="client_id" value="{{ client.id }}">
    {% endif %}
    <div id="pending-hidden" style="display:none"></div>

    <input type="hidden" name="received_at" value="{{ (ticket.received_at|default('now'))|date('Y-m-d\\TH:i') }}">

    {% if not ticket %}
    <fieldset class="form-field">
      <legend style="font-weight:600;">Vélo</legend>
      <div class="form-field">
        <label for="bike_model">Modèle</label>
        <input id="bike_model" name="bike_model" type="text" value="{{ ticket.bike_model|default(client.bike_model|default('')) }}" placeholder="Ex: Rockrider 540">
      </div>
      <div class="form-field">
        <label for="bike_notes">Notes</label>
        <textarea id="bike_notes" name="bike_notes" rows="2">{{ ticket.bike_notes|default('') }}</textarea>
      </div>
    </fieldset>
    {% else %}
    <div class="form-field">
      <strong>Vélo :</strong> {{ ticket.bike_model|default(client.bike_model|default('—')) }}
    </div>
    {% endif %}

    <div id="catalogue" x-show="showCatalogue" x-transition.opacity x-transition.duration.250ms style="transform-origin: top;">
      <h2 style="margin:16px 0 8px;">Catalogue</h2>

    {# Accordéons par catégorie #}
    {% set tvadef = env.TVA_DEFAULT|default(20) %}
    <div x-data="{ openCat: null }">
    {% for cat, items in catalogue|default({}) %}
      <div class="category" x-data="{ id: '{{ cat|e('js') }}' }" :class="{ 'open': openCat === id }">
        <div class="category-header"
             role="button"
             tabindex="0"
             :aria-expanded="openCat === id ? 'true' : 'false'"
             @click="openCat = (openCat === id ? null : id); $nextTick(() => { $el.scrollIntoView({ behavior: 'smooth', block: 'start' }); })"
             @keydown.enter.prevent="openCat = (openCat === id ? null : id)"
             @keydown.space.prevent="openCat = (openCat === id ? null : id)">
          <div style="font-weight:700; display:flex; align-items:center; gap:.5rem;">
            <i class="fas fa-cog"></i> {{ cat }}
          </div>
          <div><i class="fas" :class="openCat === id ? 'fa-chevron-up' : 'fa-chevron-down'"></i></div>
        </div>
        <template x-if="openCat === id"><div class="prestations">
          {% for item in items %}
            <div class="prestation row-card" x-data="{ 
                    checked:false, pieceChecked:false, 
                    moQty:1, pieceQty:1, 
                    moBase:0, pieceBase:0, 
                    moEdit:false, pieceEdit:false, 
                    moInput:'', pieceInput:'',
                    moFinal(){ return this.moInput!=='' && !isNaN(+this.moInput) ? +this.moInput : this.moBase; },
                    pieceFinal(){ return this.pieceInput!=='' && !isNaN(+this.pieceInput) ? +this.pieceInput : this.pieceBase; },
                    moValid(){ return this.moInput!=='' && !isNaN(+this.moInput); },
                    pieceValid(){ return this.pieceInput!=='' && !isNaN(+this.pieceInput); },
                    resetMo(){ this.moInput=''; this.moQty=1; },
                    resetPiece(){ this.pieceInput=''; this.pieceQty=1; }
                 }"
                 x-init="moBase=parseFloat($el.dataset.price)||0; pieceBase=parseFloat($el.dataset.piecePrice)||0; baseTva=parseFloat($el.dataset.tva)||20"
                 data-price="{{ item.prix_main_oeuvre_ht|default(0) }}"
                 data-tva="{{ item.tva_pct|default(tvadef) }}"
                 data-piece-price="{{ item.piece_prix_ht|default(0) }}"
                 data-piece-label="{{ item.piece_libelle|default('Pièce') }}">
              <input type="checkbox" class="round prest-check" style="width:20px;height:20px"
                     x-model="checked" @change="if($el.checked){ pieceChecked = true; } $root.recalc()">
              <div class="label">
                <div style="font-weight:600">{{ item.libelle }}</div>
              </div>

              <input type="hidden" name="prest_id[]" value="{{ item.id }}" :disabled="!checked">

              <div class="row-body">
                <!-- Main d’œuvre -->
                <div>
                  <div class="text-muted section-title" style="font-size:.8rem; display:flex; align-items:center; gap:8px;"><i class="fas fa-wrench"></i><span>Main d’œuvre</span></div>
                  <div class="price-lines">
                    Prix de base MO: <strong><span>{{ (item.prix_main_oeuvre_ht|default(0))|number_format(0, ',', ' ') }}</span> €</strong>
                  </div>
                  <div class="flex gap-8" style="align-items:center;">
                    <label class="text-muted" style="font-size:.8rem;">Qté</label>
                    <div class="qty-spinner" style="display:flex; align-items:center; gap:6px;">
                      <button type="button" class="btn btn-ghost btn-ghost-sm" :disabled="!checked" @click="moQty = Math.max(1, Number(moQty||1)-1); $root.debouncedRecalc()">−</button>
                      <input name="qty[]" type="number" min="1" :disabled="!checked" x-model="moQty" @input="$root.debouncedRecalc()" class="select-qty" style="width:64px">
                      <button type="button" class="btn btn-ghost btn-ghost-sm" :disabled="!checked" @click="moQty = Number(moQty||1)+1; $root.debouncedRecalc()">+</button>
                    </div>

                    <div class="flex gap-8" style="align-items:center;">
                      <button type="button" class="btn btn-ghost btn-ghost-sm price-soft" :disabled="!checked" 
                              x-show="!moEdit && moInput===''" 
                              @click="moEdit=true" x-transition>
                        Prix
                      </button>
                      <div x-show="moEdit" x-transition style="display:flex; align-items:center; gap:8px;">
                        <input type="number" step="0.01" placeholder="0.00" :disabled="!checked"
                               x-model="moInput" style="width:120px" @input="$root.recalc()">
                        <button type="button" class="btn" :class="moValid() ? 'btn-success' : 'btn-ghost btn-ghost-sm'"
                                @click="if(moValid()){ moEdit=false; $root.recalc(); }" x-transition>
                          Valider
                        </button>
                      </div>
                      <a href="javascript:void(0)" class="text-muted" style="font-size:.85rem;" 
                         x-show="moInput!==''" x-transition
                         @click="resetMo(); $root.recalc()">Réinitialiser</a>
                    </div>
                  </div>
                </div>

                <!-- Pièce -->
                <div>
                  <div class="text-muted section-title" style="font-size:.8rem; display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" class="round piece-check" style="width:18px;height:18px" x-model="pieceChecked" @change="$root.recalc()">
                    <i class="fas fa-puzzle-piece"></i><span x-text="$el.closest('.prestation')?.dataset?.pieceLabel || 'Pièce'">Pièce</span>
                  </div>
                  <div class="price-lines">
                    <template x-if="pieceInput===''">
                      <span>Prix de base Pièce: <strong x-text="$root.fmt(pieceBase)">{{ (item.piece_prix_ht|default(0))|number_format(2, '.', '') }}</strong> €</span>
                    </template>
                    <template x-if="pieceInput!==''">
                      <span>Prix <span style="padding:0 6px; border-radius:6px; background:#fffbeb; color:#92400e; font-weight:600;">modifié</span>: <strong x-text="$root.fmt(pieceFinal())"></strong> €</span>
                      <span class="text-muted" style="margin-left:6px;">(Prix de base Pièce: <span x-text="$root.fmt(pieceBase)"></span> €)</span>
                    </template>
                  </div>
                  <div class="flex gap-8" style="align-items:center; margin-top:6px;">
                    <label class="text-muted" style="font-size:.8rem;">Qté</label>
                    <div class="qty-spinner" style="display:flex; align-items:center; gap:6px;">
                      <button type="button" class="btn btn-ghost btn-ghost-sm" :disabled="!pieceChecked" @click="pieceQty = Math.max(1, Number(pieceQty||1)-1); $root.debouncedRecalc()">−</button>
                      <input name="piece_qty[]" type="number" min="1" :disabled="!pieceChecked" x-model="pieceQty" @input="$root.debouncedRecalc()" class="select-qty" style="width:64px">
                      <button type="button" class="btn btn-ghost btn-ghost-sm" :disabled="!pieceChecked" @click="pieceQty = Number(pieceQty||1)+1; $root.debouncedRecalc()">+</button>
                    </div>

                    <div class="flex gap-8" style="align-items:center;">
                      <button type="button" class="btn btn-ghost btn-ghost-sm price-soft" :disabled="!pieceChecked" 
                              x-show="!pieceEdit && pieceInput===''" 
                              @click="pieceEdit=true" x-transition>
                        Prix
                      </button>
                      <div x-show="pieceEdit" x-transition style="display:flex; align-items:center; gap:8px;">
                        <input type="number" step="0.01" placeholder="0.00" :disabled="!pieceChecked"
                               x-model="pieceInput" style="width:120px" @input="$root.recalc()">
                        <button type="button" class="btn" :class="pieceValid() ? 'btn-success' : 'btn-ghost btn-ghost-sm'"
                                @click="if(pieceValid()){ pieceEdit=false; $root.recalc(); }" x-transition>
                          Valider
                        </button>
                      </div>
                      <a href="javascript:void(0)" class="text-muted" style="font-size:.85rem;" 
                         x-show="pieceInput!==''" x-transition
                         @click="resetPiece(); $root.recalc()">Réinitialiser</a>
                    </div>
                  </div>
                </div>

                <!-- Inputs masqués pour POST (persistance) -->
                <input type="hidden" name="price_override[]" :value="moInput" :disabled="!checked">
                <input type="hidden" name="piece_price_override[]" :value="pieceInput" :disabled="!pieceChecked">
              </div>
            </div>
          {% endfor %}
        </div></template>
      </div>
    {% else %}
      <p class="text-muted">Le catalogue est vide. Allez dans Administration → Prestations pour le remplir.</p>
    {% endfor %}

    <!-- Tuile spéciale: Vente de vélo (toujours en dernier) -->
    <div class="category" x-data="{ id: '_bike_sale' }" :class="{ 'open': openCat === id }" data-cat="_bike_sale">
      <div class="category-header"
           role="button"
           tabindex="0"
           :aria-expanded="openCat === id ? 'true' : 'false'"
           @click="openCat = (openCat === id ? null : id); $nextTick(() => { $el.scrollIntoView({ behavior: 'smooth', block: 'start' }); })"
           @keydown.enter.prevent="openCat = (openCat === id ? null : id)"
           @keydown.space.prevent="openCat = (openCat === id ? null : id)">
        <div style="font-weight:700; display:flex; align-items:center; gap:.5rem;">
          <i class="fas fa-bicycle"></i> Vente de vélo
        </div>
        <div><i class="fas" :class="openCat === id ? 'fa-chevron-up' : 'fa-chevron-down'"></i></div>
      </div>
      <template x-if="openCat === id"><div class="prestations">
        <div class="row-card" style="display:flex; flex-direction:column; gap:8px;">
          <div>
            <label>Modèle du vélo</label>
            <input id="bike-sale-model" type="text" class="input" placeholder="Ex: Rockrider 540">
          </div>
          <div>
            <label>Prix du vélo</label>
            <input id="bike-sale-price" type="number" step="0.01" inputmode="decimal" class="input" placeholder="0.00">
          </div>
          <div>
            <button type="button" class="btn btn-secondary btn-add-bike-sale">Ajouter</button>
          </div>
        </div>
      </div></template>
    </div>

    </div>
    </div>

    {# Lignes déjà enregistrées (lecture seule) #}
    {% if prestations is not empty or consommables is not empty %}
      <h3 style="margin-top:16px;">Récapitulatif</h3>
      {% if prestations is not empty %}
        <table class="recap-table">
          <colgroup>
            <col style="width:auto">
            <col style="width:80px">
            <col style="width:120px">
            <col style="width:120px">
          </colgroup>
          <thead><tr><th>Prestation</th><th>Qté</th><th>Unitaire TTC</th><th>Sous-total TTC</th></tr></thead>
          <tbody>
          {% for p in prestations %}
            <tr>
              <td>{{ p.label }}</td>
              <td>{{ p.quantite }}</td>
              <td>{{ '%.2f'|format((p.prix_ht_snapshot|default(0)) * (1 + (p.tva_snapshot|default(tvadef))/100)) }}</td>
              <td>{{ '%.2f'|format(((p.prix_ht_snapshot|default(0)) * (1 + (p.tva_snapshot|default(tvadef))/100)) * (p.quantite|default(1))) }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% endif %}

      {% if consommables is not empty %}
        <table class="recap-table">
          <colgroup>
            <col style="width:auto">
            <col style="width:80px">
            <col style="width:120px">
            <col style="width:120px">
          </colgroup>
          <thead><tr><th>Consommable</th><th>Qté</th><th>Unitaire TTC</th><th>Sous-total TTC</th></tr></thead>
          <tbody>
          {% for c in consommables %}
            <tr>
              <td>{{ c.label }}</td>
              <td>{{ c.quantite }}</td>
              <td>{{ '%.2f'|format((c.prix_ht_snapshot|default(0)) * (1 + (c.tva_snapshot|default(tvadef))/100)) }}</td>
              <td>{{ '%.2f'|format(((c.prix_ht_snapshot|default(0)) * (1 + (c.tva_snapshot|default(tvadef))/100)) * (c.quantite|default(1))) }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endif %}



    <div x-show="pending.length > 0" style="margin-top:12px;">
      <h3>Nouveaux éléments</h3>
      <table>
        <thead><tr><th>Libellé</th><th>Qté</th><th>Sous-total TTC</th></tr></thead>
        <tbody>
          <template x-for="p in pending" :key="p.label + '-' + p.ttc">
            <tr>
              <td x-text="p.label"></td>
              <td x-text="p.qty"></td>
              <td x-text="fmt(p.ttc)"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>


    <div class="footer-sticky">
      <div class="total-pill">
        <i class="fas fa-receipt icon"></i>
        <span class="total-label">Total</span>
        <span class="total-amount" id="t-total">{{ '%.2f'|format(totaux.ttc|default(totaux.ht|default(0))) }}</span>
        <span class="text-muted" style="font-size:.9rem;">€</span>
      </div>
      <div class="flex gap-8">
        <div class="flex" style="gap:8px;">
          {% if client %}
          <a class="btn btn-ghost btn-ghost-sm" href="/clients/{{ client.id }}">Dashboard client</a>
          {% endif %}
          <button type="button" class="btn btn-secondary" @click="showCatalogue = !showCatalogue; $nextTick(()=>{ const c=document.getElementById('catalogue'); if(c && showCatalogue){ c.scrollIntoView({behavior:'smooth', block:'start'});} });">
            <i class="fas fa-plus" style="margin-right:6px;"></i>Ajouter prestation
          </button>
        </div>
        <button class="btn" type="submit"><i class="fas fa-save" style="margin-right:6px;"></i>Enregistrer</button>
        <button class="btn" type="submit" @click.prevent="handleFacturer($el)"
                {% if not ticket %}disabled{% endif %}
                name="payment_method" value="ESPECE"
                formaction="/tickets/{{ ticket ? ticket.id : 0 }}/facturer/confirm">
          <i class="fas fa-money-bill-wave" style="margin-right:6px;"></i>Espèce
        </button>
        <button class="btn btn-light-primary" type="submit" @click.prevent="handleFacturer($el)"
                {% if not ticket %}disabled{% endif %}
                name="payment_method" value="CB"
                formaction="/tickets/{{ ticket ? ticket.id : 0 }}/facturer/confirm">
          <i class="fas fa-credit-card" style="margin-right:6px;"></i>CB
        </button>
      </div>
    </div>
  </form>

  {% include 'components/pave_numerique.twig' %}

  <script>
    function ticketForm(){
      return {
        pending: [],
        showCatalogue: false,
        baseTtc: Number("{{ '%.2f'|format(totaux.ttc|default(0)) }}"),
        lastTotal: Number("{{ '%.2f'|format(totaux.ttc|default(0)) }}"),
        debounceId: null,
        debouncedRecalc(){ if (this.debounceId) clearTimeout(this.debounceId); this.debounceId = setTimeout(()=>{ this.recalc(); }, 130); },
        fmt(n){ return Number(n).toFixed(2); },
        toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 3000); },
        ttc(mq,mp,pq,pp,tva){ const ht=(Number(mq||0)*Number(mp||0))+(Number(pq||0)*Number(pp||0)); return ht*(1+Number(tva||0)/100); },
        addFromRow(id,label,mq,mp,pq,pp,tva){
          const qty = Number(mq||0) + Number(pq||0);
          const amount = this.ttc(mq,mp,pq,pp,tva);
          // Récap dynamique
          this.pending.push({ label, qty, ttc: amount });
          // Injection d'inputs cachés pour persistance
          const cont = document.getElementById('pending-hidden');
          if (cont) {
            const add = (n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=String(v); cont.appendChild(i); };
            // MO
            const moQty = Number(mq||0);
            const moPrice = (mp!==null && mp!==undefined && mp!=='') ? mp : '';
            if (moQty > 0) {
              add('prest_id[]', id);
              add('qty[]', moQty);
              add('price_override[]', moPrice);
            }
            // Pièce
            const pQty = Number(pq||0);
            const pPrice = (pp!==null && pp!==undefined && pp!=='') ? pp : '';
            if (pQty > 0) {
              add('prest_id[]', id);
              add('piece_qty[]', pQty);
              add('piece_price_override[]', pPrice);
            }
          }
          this.recalc();
        },
        recalc(){
          let total = this.baseTtc || 0;
          document.querySelectorAll('.prestation').forEach((row)=>{
            const moCb = row.querySelector('input.prest-check');
            const pieceCb = row.querySelector('input.piece-check');
            const includeRow = ((moCb && moCb.checked) || (pieceCb && pieceCb.checked));
            if (!includeRow) return;

            // MO
            let qty = 0, price = 0;
            if (moCb && moCb.checked) {
              const qtyEl = row.querySelector("select[name='qty[]']") || row.querySelector("input[name='qty[]']");
              const ovEl  = row.querySelector("input[name='price_override[]']");
              qty = parseFloat(qtyEl?.value || '0'); if (isNaN(qty) || qty < 0) qty = 0;
              price = parseFloat(ovEl?.value || '');
              if (isNaN(price)) price = parseFloat(row.dataset.price || '0');
            }

            // Pièce
            let pqty = 0, pprice = 0;
            if (pieceCb && pieceCb.checked) {
              const pQtyEl = row.querySelector("select[name='piece_qty[]']");
              const pOvEl  = row.querySelector("input[name='piece_price_override[]']");
              pqty = parseFloat(pQtyEl?.value || '0'); if (isNaN(pqty) || pqty < 0) pqty = 0;
              pprice = parseFloat(pOvEl?.value || '');
              if (isNaN(pprice)) pprice = parseFloat(row.dataset.piecePrice || '0');
            }

            total += (qty * price) + (pqty * pprice);
          });
          const fmt = (n) => Number(n).toFixed(2);
          const totalEl = document.getElementById('t-total');
          if (totalEl) {
            totalEl.textContent = fmt(total);
            // Inject CSS bounce une seule fois
            if (!document.getElementById('css-total-bounce')) {
              const st = document.createElement('style');
              st.id = 'css-total-bounce';
              st.textContent = '@keyframes totalBounce{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}} .total-pill.bounce{animation:totalBounce .3s ease-in-out}';
              document.head.appendChild(st);
            }
            const pill = document.querySelector('.total-pill');
            if (pill && total !== this.lastTotal) {
              pill.classList.add('bounce');
              setTimeout(()=>pill.classList.remove('bounce'), 350);
              this.lastTotal = total;
            }
          }
        },
        handleFacturer(btn){
          const ph = document.getElementById('pending-hidden');
          const hasPending = (this.pending && this.pending.length > 0) || (ph && ph.children && ph.children.length > 0);
          let proceed = true;
          if (hasPending) {
            proceed = window.confirm("Vous n'avez pas enregistré l'ajout de prestation. Poursuivre la facturation ?");
          }
          if (!proceed) return;
          const form = btn.form || document.querySelector('form');
          if (!form) return;
          const fa = btn.getAttribute('formaction');
          if (fa) form.setAttribute('action', fa);
          const fm = btn.getAttribute('formmethod');
          if (fm) form.setAttribute('method', fm);

          // Injecter le mode de paiement (le submit() programmatique ne soumet pas le name/value du bouton)
          const existing = form.querySelector('input[name="payment_method"]');
          if (existing) existing.remove();
          const pm = btn.getAttribute('value') || btn.getAttribute('data-payment') || '';
          if (pm) {
            const i = document.createElement('input');
            i.type = 'hidden';
            i.name = 'payment_method';
            i.value = pm;
            form.appendChild(i);
          }
          form.submit();
        }
      }
    }
    // Ajout "Vente de vélo" (carte spéciale)
    (function(){
      document.addEventListener('click', function(e){
        const btn = e.target && e.target.closest ? e.target.closest('.btn-add-bike-sale') : null;
        if (!btn) return;
        const modelEl = document.getElementById('bike-sale-model');
        const priceEl = document.getElementById('bike-sale-price');
        const model = (modelEl && modelEl.value ? String(modelEl.value).trim() : '');
        let price = 0;
        try { price = parseFloat(priceEl && priceEl.value ? String(priceEl.value).replace(',', '.') : '0'); } catch(_e) { price = 0; }
        if (!model) { alert('Saisir le modèle du vélo'); if (modelEl) modelEl.focus(); return; }
        if (!(Number.isFinite(price) && price >= 0)) { alert('Saisir un prix valide'); if (priceEl) priceEl.focus(); return; }
        // Injecter inputs cachés pour persistance
        const cont = document.getElementById('pending-hidden');
        if (cont) {
          const add = (n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=String(v); cont.appendChild(i); };
          add('custom_bike_label[]', 'Vente de vélo — ' + model);
          add('custom_bike_price[]', String(price));
        }
        // Essayer de mettre à jour le récap dynamique via l'instance Alpine
        try {
          const root = document.querySelector('form[x-data]');
          const data = root && root.__x ? root.__x.$data : null;
          if (data && Array.isArray(data.pending)) {
            const ttc = (typeof data.ttc === 'function') ? data.ttc(0,0,1,price,0) : price;
            data.pending.push({ label: 'Vente de vélo — ' + model, qty: 1, ttc: ttc });
            if (typeof data.recalc === 'function') data.recalc();
            if (typeof data.toast === 'function') data.toast('Vente de vélo ajoutée ✓');
          }
        } catch(_e){}
        // Nettoyer les champs
        if (modelEl) modelEl.value = '';
        if (priceEl) priceEl.value = '';
      });
    })();

    // Affiche un toast simple si ?success=1
    (function(){
      const u = new URL(window.location.href);
      if (u.searchParams.get('success') === '1') {
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = 'Enregistré ✓';
        document.body.appendChild(t);
        setTimeout(()=>{ t.remove(); }, 5000);
      }
    })();
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.note-edit-btn').forEach(function(btn){
      var card = btn.closest('.client-card') || btn.closest('.card') || btn.parentElement;
      if (!card) return;
      var displayBlock = card.querySelector('.note-display');
      var form = card.querySelector('.note-form');
      var cancelBtn = card.querySelector('.btn-note-cancel');
      var textarea = card.querySelector('.note-textarea');
      function enterEditMode() {
        if (form) form.style.display = 'block';
        if (displayBlock) displayBlock.style.display = 'none';
        if (textarea) {
          textarea.focus();
          try { var len = textarea.value.length; textarea.setSelectionRange(len, len); } catch(_e){}
        }
      }
      function exitEditMode() {
        if (form) form.style.display = 'none';
        if (displayBlock) displayBlock.style.display = 'block';
      }
      btn.addEventListener('click', enterEditMode);
      if (cancelBtn) cancelBtn.addEventListener('click', function (e) { e.preventDefault(); exitEditMode(); });
    });
  });
  </script>
{% endblock %}
