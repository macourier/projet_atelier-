{% extends 'layout.twig' %}

{% block title %}Administration ‚Äî Prestations{% endblock %}

{% block content %}
<h1>Catalogue des prestations</h1>
{% if env.APP_DEBUG|default('false') == 'true' and (is_local|default(false)) %}
  <div class="text-muted" style="margin:6px 0; padding:6px; border:1px dashed #94a3b8; border-radius:8px; background:#f8fafc;">
    DEBUG ‚Äî piece_supported: {{ piece_supported ? 'true' : 'false' }}, cols: {{ debug_cols|default([])|join(', ') }}, DB(env): {{ env.DB_PATH|default('') }}, DB(main): {{ (db_list|first).file|default('') }}
  </div>
{% endif %}
{% if piece_supported is defined and not piece_supported %}
  <div class="text-muted" style="margin:8px 0 4px; padding:8px; border:1px dashed #f59e0b; border-radius:8px; background:#fffbeb;">
    Mode compatibilit√©: la base n'est pas encore √† jour pour les champs ‚ÄúPi√®ce‚Äù. Les champs Pi√®ce sont temporairement masqu√©s.
  </div>
{% endif %}

<style>
  /* Accord√©ons */
  .acc { display: grid; gap: 12px; margin: 8px 0; }
  .acc-section { border-radius: 12px; border: 1px solid #e5e7eb; background:#fff; overflow: hidden; }
  .acc-header { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; font-weight:700; font-size:17px; background:#f3f4f6; cursor:pointer; user-select:none; }
  .acc-section.open .acc-header { background:#eef2ff; }
  .acc-title { display:flex; align-items:center; gap:8px; }
  .acc-chevron { transition: transform .2s ease; }
  .acc-section.open .acc-chevron { transform: rotate(180deg); }
  .acc-panel { display:none; padding:12px; }
  .acc-section.open .acc-panel { display:block; }

  /* Grille de cartes */
  .cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:12px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .card-title { font-weight:600; margin-bottom:6px; font-size:16px; }
  label { font-size:14px; color:#6b7280; display:block; margin:6px 0 4px; }
  .cell.lg { font-size:16px; line-height:1.2; padding:10px 12px; height:44px; border-radius:10px; border:1px solid #d1d5db; width:100%; }
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

  .row-actions { display:flex; gap:8px; margin-top:10px; }
  .btn { border:none; padding:12px 14px; border-radius:10px; font-size:15px; cursor:pointer; }
  .btn-save { background:#d1fae5; color:#065f46; }
  .btn-danger { background:#fee2e2; color:#991b1b; }
  .btn:hover { filter:brightness(0.98); }

  /* Carte sp√©ciale (nouvelle prestation) */
  .card-new { background: linear-gradient(180deg, #f0f7ff 0%, #ffffff 100%); border:1px solid #cfe8ff; }
  .card-new .card-title { color:#0b4da1; font-weight:700; }
  .card-new .cell.lg { background: #ffffff; }
  .btn-add-prest { background:#3b82f6; color:#fff; border-radius:10px; padding:10px 14px; border:none; cursor:pointer; }
  .btn-add-prest:hover { filter:brightness(0.95); }
  .btn-cancel-new { background: transparent; border:1px solid #ef4444; color:#991b1b; border-radius:10px; padding:10px 12px; cursor:pointer; }
  .card-new .row-actions { display:flex; gap:8px; margin-top:10px; justify-content:center; }

  @media (max-width: 640px) {
    .grid-2 { grid-template-columns:1fr; }
    .cell.lg { font-size:17px; }
    .acc-header { font-size:18px; padding:16px; }
  }
</style>



<!-- Barre de recherche (conserv√©e) -->
<div class="toolbar-inline">
  <div class="form-field" style="margin:10px 0;">
    <label for="prest-search">Recherche</label>
    <input type="text" id="prest-search" class="input" placeholder="mot cl√© (cat√©gorie, manoeuvre)" style="min-width:260px;" />
  </div>
</div>

<!-- Ajouter (hors acc-root pour ne pas √™tre filtr√©) -->
<section class="acc-section acc-add no-filter" data-cat="_ajouter">
  <header class="acc-header" tabindex="0" role="button">
    <span class="acc-title"><i class="fas fa-plus"></i> Gestions des cat√©gories</span>
    <i class="fas fa-chevron-down acc-chevron"></i>
  </header>
  <div class="acc-panel">
    <div class="card-add">
      <h3 class="card-add-title" style="margin-top:0">‚ûï Ajouter une categorie</h3>
      <form id="form-add-category" method="post" action="/admin/categories" novalidate>
        <div class="form-stack">
          <div class="form-field">
            <label for="add_category_name">Nom de la cat√©gorie</label>
            <input type="text" id="add_category_name" name="name" class="input" placeholder="Ex : Transmission" required />
          </div>
          <div class="form-actions">
            <button class="btn btn-accent" type="submit">Ajouter la cat√©gorie</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Suppression de cat√©gorie (dropdown) -->
    <div class="card" style="background:#F4F7FB; border:1px solid #dbe6f4; border-radius:14px; padding:16px; margin-top:12px;">
      <h3 style="margin:0 0 8px;">Suppression de cat√©gorie</h3>
      <div style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;">
        <div style="min-width:240px; flex:1;">
          <label style="font-size:14px; color:#6b7280; display:block; margin:0 0 4px;">Cat√©gorie √† supprimer</label>
          <select id="cat-delete-select" class="input">
            <option value="">‚Äî S√©lectionner ‚Äî</option>
            {% for c in categories|default([]) %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="button" class="btn btn-ghost btn-ghost-sm btn-cat-bulk-delete" style="background:#fee2e2; color:#991b1b; border:1px solid #fecaca;">Supprimer la cat√©gorie</button>
      </div>
    </div>
  </div>
</section>

<div class="acc" id="acc-root">
  {% for cat, items in grouped_prestas|default({ 'Autre' : prestations|default([]) }) %}
  <section class="acc-section" data-cat="{{ cat }}">
    <header class="acc-header" tabindex="0" role="button">
      <span class="acc-title"><i class="fas fa-cog"></i> {{ cat }}</span>
      <i class="fas fa-chevron-down acc-chevron"></i>
    </header>
    <div class="acc-panel">
      <div class="cards">
        <!-- Carte sp√©ciale : ajouter une prestation dans cette cat√©gorie -->
        <div class="card card-new" data-new-for="{{ cat }}">
          <div class="card-title">Nouvelle prestation ‚Äî {{ cat }}</div>
          <div class="card-body">
            <label>Man≈ìuvre</label>
            <input class="cell lg" name="new_libelle" placeholder="Ex : R√©glage d√©railleur" />
            <label>Prix main d‚Äô≈ìuvre</label>
            <input class="cell lg" name="new_prix_main_oeuvre_ht" type="number" step="0.01" inputmode="decimal" placeholder="Main d‚Äô≈ìuvre (‚Ç¨)" />
            <label>Pi√®ce</label>
            <input class="cell lg" name="new_piece_libelle" placeholder="Pi√®ce (optionnel)" />
            <label>Prix pi√®ce</label>
            <input class="cell lg" name="new_piece_prix_ht" type="number" step="0.01" inputmode="decimal" placeholder="Pi√®ce (‚Ç¨)" />
            <div class="row-actions">
              <button class="btn btn-add-prest" type="button">‚ûï Ajouter une prestation</button>
            </div>
          </div>
        </div>

        {% for p in items %}
        <div class="card" data-id="{{ p.id }}">
          <div class="card-title">{{ p.libelle }}</div>
          <div class="card-body">

            <label>Man≈ìuvre</label>
            <input class="cell lg" name="libelle" value="{{ p.libelle }}" />

            {% if piece_supported|default(false) %}
            <label>Pi√®ce</label>
            <input class="cell lg" name="piece_libelle" value="{{ p.piece_libelle|default('Pi√®ce') }}" placeholder="Pi√®ce" />
            {% endif %}

            <div class="grid-2">
              <div>
                <label>Prix MO</label>
          <input class="cell lg" name="prix_main_oeuvre_ht" type="number" step="0.01" inputmode="decimal" value="{{ p.prix_main_oeuvre_ht }}" />
              </div>
              {% if piece_supported|default(false) %}
              <div>
                <label>Prix pi√®ce</label>
          <input class="cell lg" name="piece_prix_ht" type="number" step="0.01" inputmode="decimal" value="{{ p.piece_prix_ht|default(0) }}" />
              </div>
              {% endif %}
            </div>

            <div class="row-actions">
              <button class="btn btn-save" type="button"><span>üíæ</span> Enregistrer</button>
              <form method="post" action="/admin/prestations/{{ p.id }}/delete" onsubmit="return confirm('Supprimer {{ p.libelle }} ?');">
                <button class="btn btn-danger" type="submit"><span>üóëÔ∏è</span> Supprimer</button>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
(function(){
  const search = document.getElementById('prest-search');
  const acc = document.getElementById('acc-root');

  // Toggle accord√©ons (ouverture exclusive + ARIA) ‚Äî delegation fallback
  const root = document.getElementById('acc-root') || document;
  console.log('[instrument] delegation enabled for .acc-header');
  // Helper to toggle a section given a header element
  function toggleSectionFromHeader(h) {
    const sec = h && h.closest ? h.closest('.acc-section') : null;
    if (!sec || !root) { console.log('[instrument] toggle aborted: no sec/root', sec, root); return; }
    const wasOpen = sec.classList.contains('open');
    // Fermer toutes les autres
    root.querySelectorAll('.acc-section.open').forEach(s => {
      if (s !== sec) {
        s.classList.remove('open');
        const hh = s.querySelector('.acc-header');
        if (hh) hh.setAttribute('aria-expanded', 'false');
      }
    });
    // Bascule de la courante + ARIA
    if (wasOpen) {
      sec.classList.remove('open');
      h.setAttribute('aria-expanded', 'false');
    } else {
      sec.classList.add('open');
      h.setAttribute('aria-expanded', 'true');
    }
  }
  // Ensure ARIA attributes are present for existing headers
  document.querySelectorAll('.acc-header').forEach(h => {
    try {
      h.setAttribute('role','button');
      h.setAttribute('tabindex','0');
      const sec = h.closest('.acc-section');
      h.setAttribute('aria-expanded', sec?.classList.contains('open') ? 'true' : 'false');
    } catch(_e){}
  });
  // Delegated click handler for headers
  document.addEventListener('click', (e) => {
    const h = e.target.closest && e.target.closest('.acc-header');
    if (!h) return;
    toggleSectionFromHeader(h);
  });
  // Keyboard activation (Enter / Space) when header is focused
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const active = document.activeElement;
    if (active && active.classList && active.classList.contains('acc-header')) {
      e.preventDefault();
      toggleSectionFromHeader(active);
    }
  });

  // JS ‚Äî Formulaire d‚Äôajout (carte tactile)
  const formAdd = document.getElementById('form-add-prest');
  if (formAdd) {
    const selCat = document.getElementById('add_categorie_select');
    const catNew = document.getElementById('add_categorie_new');
    const catReal = document.getElementById('add_categorie_real');
    const lib = document.getElementById('add_libelle');
    const prixMo = document.getElementById('add_prix_mo');
    const selPiece = document.getElementById('add_piece_select');
    const pieceText = document.getElementById('add_piece_text');
    const prixPiece = document.getElementById('add_prix_piece');

    // Peupler cat√©gories √† partir des sections existantes
    try {
      const cats = new Set();
      document.querySelectorAll('#acc-root .acc-section:not(.no-filter)').forEach(sec => {
        const c = (sec.getAttribute('data-cat') || '').trim();
        if (c) cats.add(c);
      });
      [...cats].sort().forEach(c => {
        if (!selCat.querySelector(`option[value="${CSS.escape(c)}"]`)) {
          const opt = document.createElement('option');
          opt.value = c; opt.textContent = c; selCat.appendChild(opt);
        }
      });
    } catch(_e) {}

    // Peupler pi√®ces (si support√©es) depuis les cartes
    if (selPiece && pieceText) {
      try {
        const pieces = new Set();
        document.querySelectorAll('input[name="piece_libelle"]').forEach(i => {
          const v = (i.value || '').trim(); if (v) pieces.add(v);
        });
        [...pieces].sort().forEach(p => {
          if (!selPiece.querySelector(`option[value="${CSS.escape(p)}"]`)) {
            const opt = document.createElement('option'); opt.value = p; opt.textContent = p; selPiece.appendChild(opt);
          }
        });
      } catch(_e) {}
    }

    function syncCategorieReal() {
      if (!selCat || !catReal) return;
      if (selCat.value === '__new__') {
        if (catNew) { catNew.style.display = ''; }
        if (catNew && catNew.value.trim() !== '') { catReal.value = catNew.value.trim(); }
        if (catNew && catNew.value.trim() === '') { catNew.focus(); }
      } else {
        if (catNew) { catNew.style.display = 'none'; }
        catReal.value = selCat.value || '';
        if (lib && selCat.value) lib.focus();
      }
    }
    if (selCat) selCat.addEventListener('change', syncCategorieReal);
    if (catNew) catNew.addEventListener('input', ()=>{ if (selCat && selCat.value==='__new__') catReal.value = catNew.value.trim(); });

    if (selPiece && pieceText) {
      selPiece.addEventListener('change', () => {
        pieceText.value = selPiece.value;
        if (selPiece.value) pieceText.setAttribute('aria-disabled','true'); else pieceText.removeAttribute('aria-disabled');
      });
    }

    // ENTER dans "Man≈ìuvre" soumet le formulaire
    if (lib) lib.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); formAdd.requestSubmit(); } });

    // Validation simple des nombres
    function validateNumber(el){ const v = Number(el.value); if (!Number.isFinite(v) || v < 0) el.classList.add('input-error'); else el.classList.remove('input-error'); }
    if (prixMo) prixMo.addEventListener('input', ()=>validateNumber(prixMo));
    if (prixPiece) prixPiece.addEventListener('input', ()=>validateNumber(prixPiece));

    formAdd.addEventListener('submit', (e) => {
      if (selCat && selCat.value === '__new__' && catNew && catNew.value.trim() === '') {
        e.preventDefault(); catNew.focus(); if (typeof showToast === 'function') showToast('Saisir une cat√©gorie', true); return;
      }
      if (catReal && (!catReal.value || catReal.value.trim()==='')) {
        e.preventDefault(); if (selCat) selCat.focus(); if (typeof showToast === 'function') showToast('S√©lectionner une cat√©gorie', true); return;
      }
      if (prixMo) prixMo.value = String(prixMo.value || '').replace(',', '.');
      if (prixPiece) prixPiece.value = String(prixPiece.value || '').replace(',', '.');
    });

    // Init
    syncCategorieReal();
  }

  // Ajouter prestation (carte sp√©ciale)
  document.addEventListener('click', async (e) => {
    const btnAdd = e.target.closest('.btn-add-prest');
    if (btnAdd) {
      const card = btnAdd.closest('.card') || btnAdd.closest('.card-new');
      const section = card.closest('.acc-section');
      const cat = section?.getAttribute('data-cat') || card.dataset?.newFor || '';
      const lib = card.querySelector('input[name="new_libelle"]')?.value || '';
      const prix = card.querySelector('input[name="new_prix_main_oeuvre_ht"]')?.value || '';
      const pl = card.querySelector('input[name="new_piece_libelle"]')?.value || '';
      const pp = card.querySelector('input[name="new_piece_prix_ht"]')?.value || '';
      const form = new FormData();
      form.append('categorie', cat);
      form.append('libelle', lib);
      form.append('prix_main_oeuvre_ht', prix);
      if (pl) form.append('piece_libelle', pl);
      if (pp) form.append('piece_prix_ht', pp);
      try {
        const res = await fetch('/admin/prestations', { method: 'POST', body: form });
        if (res.status === 204 || res.status === 201 || res.status === 200 || res.status === 302) {
          showToast('Prestation ajout√©e ‚úì');
          setTimeout(()=>{ location.reload(); }, 600);
        } else {
          console.warn('Add non 2xx', await res.text());
          showToast('Erreur ajout', true);
        }
      } catch (err) {
        console.error(err);
        showToast('Erreur r√©seau', true);
      }
      return;
    }
    const btnCancel = e.target.closest('.btn-cancel-new');
    if (btnCancel) {
      const card = btnCancel.closest('.card-new');
      if (card) {
        card.querySelectorAll('input').forEach(i => i.value = '');
      }
      return;
    }
  });
  
  // Suppression par cat√©gorie (select + confirmer)
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-cat-bulk-delete');
    if (!btn) return;
    const sel = document.getElementById('cat-delete-select');
    const id = sel && sel.value ? sel.value : '';
    if (!id) { if (typeof showToast==='function') showToast('Choisir une cat√©gorie', true); return; }
    const ok = window.confirm("Supprimer cette cat√©gorie supprimera aussi toutes les prestations associ√©es.\nAction irr√©versible. Continuer ?");
    if (!ok) return;
    try {
      const res = await fetch(`/admin/categories/${encodeURIComponent(id)}/delete`, { method:'POST' });
      if (res.status === 302 || res.status === 204 || res.status === 200) {
        if (typeof showToast==='function') showToast('Cat√©gorie supprim√©e ‚úì');
        setTimeout(()=>{ location.reload(); }, 500);
      } else {
        console.warn('Delete cat non 2xx', await res.text());
        if (typeof showToast==='function') showToast('Erreur suppression', true);
      }
    } catch(err) {
      console.error(err);
      if (typeof showToast==='function') showToast('Erreur r√©seau', true);
    }
  });

  // Save par carte
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-save');
    if (!btn) return;
    const card = btn.closest('.card');
    const id = card?.dataset?.id;
    if (!id) return;

    const section = card.closest('.acc-section');
    const cat = section?.getAttribute('data-cat') || '';
    const lib = card.querySelector('input[name="libelle"]')?.value || '';
    const prix = card.querySelector('input[name="prix_main_oeuvre_ht"]')?.value || '';
    const plEl = card.querySelector('input[name="piece_libelle"]');
    const ppEl = card.querySelector('input[name="piece_prix_ht"]');

    const form = new FormData();
    form.append('categorie', cat);
    form.append('libelle', lib);
    form.append('prix_main_oeuvre_ht', prix);
    if (plEl) form.append('piece_libelle', plEl.value);
    if (ppEl) form.append('piece_prix_ht', ppEl.value);

    try {
      const res = await fetch(`/admin/prestations/${encodeURIComponent(id)}`, { method: 'POST', body: form });
      if (res.status !== 204) {
        console.warn('Update non 204', await res.text());
        showToast('Erreur de sauvegarde', true);
      } else {
        showToast('Enregistr√© ‚úì');
        card.style.transition = 'background-color .3s ease';
        const bg = card.style.backgroundColor;
        card.style.backgroundColor = '#ecfdf5';
        setTimeout(()=>{ card.style.backgroundColor = bg || ''; }, 600);
      }
    } catch (err) {
      console.error(err);
      showToast('Erreur r√©seau', true);
    }
  });

  // Supprimer prestation (carte existante) avec confirm + toast
  document.addEventListener('click', async (e) => {
    const delBtn = e.target.closest('form[action*="/admin/prestations/"][action$="/delete"] .btn-danger');
    if (!delBtn) return;
    e.preventDefault();
    const form = delBtn.closest('form');
    const card = delBtn.closest('.card');
    const title = card?.querySelector('.card-title')?.textContent?.trim() || 'cette prestation';
    if (!window.confirm(`Supprimer ${title} ?`)) return;
    try {
      const res = await fetch(form.action, { method: 'POST' });
      if (res.status === 204 || res.status === 200 || res.status === 302) {
        showToast('Prestation supprim√©e ‚úì');
        const sec = card.closest('.acc-section');
        card.remove();
        // Masquer la section si plus aucune carte prestation (hors carte "nouvelle prestation")
        if (sec && !sec.querySelector('.card[data-id]')) {
          sec.style.display = 'none';
        }
      } else {
        console.warn('Delete non 2xx', await res.text());
        showToast('Erreur suppression', true);
      }
    } catch (err) {
      console.error(err);
      showToast('Erreur r√©seau', true);
      // Fallback: soumission classique si fetch indisponible
      try { form.submit(); } catch(_e){}
    }
  });
  
  // Recherche: filtre cartes et replie sections vides
  if (search) {
    search.addEventListener('input', () => {
      const q = search.value.trim().toLowerCase();
      document.querySelectorAll('#acc-root .acc-section:not(.no-filter)').forEach(sec => {
        let anyVisible = false;
        sec.querySelectorAll('.card').forEach(card => {
          const txt = card.innerText.toLowerCase();
          const vis = (q === '') || txt.includes(q);
          card.style.display = vis ? '' : 'none';
          if (vis) anyVisible = true;
        });
        // Masquer la section si aucune carte visible
        sec.style.display = anyVisible ? '' : 'none';
      });
    });
  }

  function showToast(text, err) {
    let t = document.getElementById('toast');
    if (!t) {
      t = document.createElement('div');
      t.id = 'toast';
      t.style.position='fixed'; t.style.bottom='20px'; t.style.left='50%'; t.style.transform='translateX(-50%)';
      t.style.padding='10px 14px'; t.style.borderRadius='8px'; t.style.color='#fff';
      t.style.background = '#0366d6';
      t.style.zIndex = 2000;
      document.body.appendChild(t);
    }
    t.textContent = text;
    t.style.background = err ? '#b00020' : '#16a34a';
    t.style.display='block';
    setTimeout(()=>{ t.style.display='none'; }, 2000);
  }
})();
});
</script>
{% endblock %}
