{% set tvadef = env.TVA_DEFAULT|default(20) %}

{# Bloc récapitulatif : affiche les prestations existantes ET les nouvelles sélections #}
{% if (prestations is defined and prestations is not empty) or (consommables is defined and consommables is not empty) %}
  {# Ticket existant : afficher les prestations déjà enregistrées #}
  <div style="margin-top:12px;">
    <h3 style="color:#444; font-weight:700;">Récapitulatif</h3>
    
    {# Tableau Prestations existantes (MO) - Exclure les ventes de vélo #}
    {% set realPrestations = [] %}
    {% set ventesVelo = [] %}
    {% for p in prestations %}
      {% if p.label starts with 'Vente —' or p.label starts with 'Vente de vélo —' %}
        {% set ventesVelo = ventesVelo|merge([p]) %}
      {% else %}
        {% set realPrestations = realPrestations|merge([p]) %}
      {% endif %}
    {% endfor %}
    
    {% if realPrestations is not empty %}
    <table class="recap-table">
      <thead>
        <tr>
          <th>Prestation</th>
          <th>Qté</th>
          <th>Unitaire</th>
          <th>Sous-total</th>
        </tr>
      </thead>
      <tbody>
        {% for p in realPrestations %}
        <tr>
          <td>{{ p.label }}</td>
          <td>{{ p.quantite }}</td>
          <td>{{ '%.2f'|format(p.prix_ht_snapshot|default(0)) }}</td>
          <td>{{ '%.2f'|format((p.prix_ht_snapshot|default(0)) * (p.quantite|default(1))) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}

    {# Tableau Consommables existants (Pièces) #}
    {% if consommables is not empty %}
    <table class="recap-table">
      <thead>
        <tr>
          <th>Consommable</th>
          <th>Qté</th>
          <th>Unitaire</th>
          <th>Sous-total</th>
        </tr>
      </thead>
      <tbody>
        {% for c in consommables %}
        <tr>
          <td>{{ c.label }}</td>
          <td>{{ c.quantite }}</td>
          <td>{{ '%.2f'|format(c.prix_ht_snapshot|default(0)) }}</td>
          <td>{{ '%.2f'|format((c.prix_ht_snapshot|default(0)) * (c.quantite|default(1))) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}

    {# Tableau Ventes de vélo existantes #}
    {% if ventesVelo is not empty %}
    <table class="recap-table">
      <thead>
        <tr>
          <th>Vente</th>
          <th>Qté</th>
          <th>Unitaire</th>
          <th>Sous-total</th>
        </tr>
      </thead>
      <tbody>
        {% for v in ventesVelo %}
        <tr>
          <td>{{ v.label }}</td>
          <td>{{ v.quantite }}</td>
          <td>{{ '%.2f'|format(v.prix_ht_snapshot|default(0)) }}</td>
          <td>{{ '%.2f'|format((v.prix_ht_snapshot|default(0)) * (v.quantite|default(1))) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
{% endif %}

{# Bloc récapitulatif dynamique pour les nouvelles sélections #}
<div x-show="pending.length > 0" style="margin-top:12px;">
  <h3 style="color:#444; font-weight:700;" x-show="!{{ (prestations is defined and prestations is not empty) or (consommables is defined and consommables is not empty) ? 'true' : 'false' }}">Récapitulatif</h3>

  {# Tableau Prestations (MO) #}
  <template x-if="pending.some(p => p.moQty > 0)">
    <table class="recap-table">
      <thead>
        <tr>
          <th>Prestation</th>
          <th>Qté</th>
          <th>Unitaire</th>
          <th>Sous-total</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="p in pending" :key="p.id + '-mo'">
          <tr x-show="p.moQty > 0">
            <td x-text="p.label"></td>
            <td x-text="p.moQty"></td>
            <td x-text="fmt(p.moUnit)"></td>
            <td x-text="fmt(p.moTotal)"></td>
          </tr>
        </template>
      </tbody>
    </table>
  </template>

  {# Tableau Consommables (Pièces) #}
  <template x-if="pending.some(p => p.pieceQty > 0)">
    <table class="recap-table">
      <thead>
        <tr>
          <th>Consommable</th>
          <th>Qté</th>
          <th>Unitaire</th>
          <th>Sous-total</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="p in pending" :key="p.id + '-piece'">
          <tr x-show="p.pieceQty > 0">
            <td x-text="p.pieceLabel || p.label"></td>
            <td x-text="p.pieceQty"></td>
            <td x-text="fmt(p.pieceUnit)"></td>
            <td x-text="fmt(p.pieceTotal)"></td>
          </tr>
        </template>
      </tbody>
    </table>
  </template>

  {# Tableau Vente de vélo #}
  <template x-if="pending.some(p => p.type === 'bike')">
    <table class="recap-table">
      <thead>
        <tr>
          <th>Vente</th>
          <th>Qté</th>
          <th>Unitaire</th>
          <th>Sous-total</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="p in pending" :key="(p.id || p.label) + '-bike'">
          <tr x-show="p.type === 'bike'">
            <td x-text="p.label"></td>
            <td x-text="p.qty"></td>
            <td x-text="fmt(p.unit)"></td>
            <td x-text="fmt(p.subtotal)"></td>
          </tr>
        </template>
      </tbody>
    </table>
  </template>
</div>
