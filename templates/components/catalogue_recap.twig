{% set tvadef = env.TVA_DEFAULT|default(20) %}

{# Bloc récapitulatif FUSIONNÉ : affiche les prestations existantes + les nouvelles sélections dans un seul bloc #}

{# Préparer les données existantes #}
{% set realPrestations = [] %}
{% set ventesVelo = [] %}
{% if prestations is defined and prestations is not empty %}
  {% for p in prestations %}
    {% if p.label starts with 'Vente —' or p.label starts with 'Vente de vélo —' %}
      {% set ventesVelo = ventesVelo|merge([p]) %}
    {% else %}
      {% set realPrestations = realPrestations|merge([p]) %}
    {% endif %}
  {% endfor %}
{% endif %}

{# Afficher le titre si il y a du contenu (existant OU nouveau) #}
<div x-show="(pending.length > 0) || {{ (realPrestations is not empty or (consommables is defined and consommables is not empty) or ventesVelo is not empty) ? 'true' : 'false' }}" style="margin-top:32px;">
  <h3 style="color:#444; font-weight:700;">Récapitulatif</h3>

  {# ============= TABLEAU PRESTATIONS (MO) ============= #}
  <table class="recap-table" x-show="({{ realPrestations is not empty ? 'true' : 'false' }}) || pending.some(p => p.moQty > 0)">
    <thead>
      <tr>
        <th>Prestation</th>
        <th>Qté</th>
        <th>Unitaire</th>
        <th>Sous-total</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {# Lignes existantes (Twig) #}
      {% for p in realPrestations %}
      <tr>
        <td>{{ p.label }}</td>
        <td>{{ p.quantite }}</td>
        <td>{{ '%.2f'|format(p.prix_ht_snapshot|default(0)) }}</td>
        <td>{{ '%.2f'|format((p.prix_ht_snapshot|default(0)) * (p.quantite|default(1))) }}</td>
        <td style="text-align:center;">
          <button type="button" class="btn-remove-row" title="Supprimer" onclick="if(confirm('Supprimer cette prestation ?')){fetch('/tickets/{{ ticket.id }}/prestations/{{ p.id }}/delete',{method:'POST'}).then(r=>r.ok?window.location.reload():alert('Erreur'));}">−</button>
        </td>
      </tr>
      {% endfor %}
      
      {# Lignes nouvelles (Alpine.js) #}
      <template x-for="(p, idx) in pending" :key="p.id + '-mo'">
        <tr x-show="p.moQty > 0">
          <td x-text="p.label"></td>
          <td x-text="p.moQty"></td>
          <td x-text="fmt(p.moUnit)"></td>
          <td x-text="fmt(p.moTotal)"></td>
          <td style="text-align:center;">
            <button type="button" class="btn-remove-row" @click="removeMo(p.id)" title="Supprimer cette ligne" style="display:inline-block;">−</button>
          </td>
        </tr>
      </template>
    </tbody>
  </table>

  {# ============= TABLEAU CONSOMMABLES (PIÈCES) ============= #}
  <table class="recap-table" x-show="({{ (consommables is defined and consommables is not empty) ? 'true' : 'false' }}) || pending.some(p => p.pieceQty > 0)">
    <thead>
      <tr>
        <th>Consommable</th>
        <th>Qté</th>
        <th>Unitaire</th>
        <th>Sous-total</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {# Lignes existantes (Twig) #}
      {% if consommables is defined and consommables is not empty %}
        {% for c in consommables %}
        <tr>
          <td>{{ c.label }}</td>
          <td>{{ c.quantite }}</td>
          <td>{{ '%.2f'|format(c.prix_ht_snapshot|default(0)) }}</td>
          <td>{{ '%.2f'|format((c.prix_ht_snapshot|default(0)) * (c.quantite|default(1))) }}</td>
          <td style="text-align:center;">
            <button type="button" class="btn-remove-row" title="Supprimer" onclick="if(confirm('Supprimer ce consommable ?')){fetch('/tickets/{{ ticket.id }}/prestations/{{ c.id }}/delete',{method:'POST'}).then(r=>r.ok?window.location.reload():alert('Erreur'));}">−</button>
          </td>
        </tr>
        {% endfor %}
      {% endif %}
      
      {# Lignes nouvelles (Alpine.js) #}
      <template x-for="(p, idx) in pending" :key="p.id + '-piece'">
        <tr x-show="p.pieceQty > 0">
          <td x-text="p.pieceLabel || p.label"></td>
          <td x-text="p.pieceQty"></td>
          <td x-text="fmt(p.pieceUnit)"></td>
          <td x-text="fmt(p.pieceTotal)"></td>
          <td style="text-align:center;">
            <button type="button" class="btn-remove-row" @click="removePiece(p.id)" title="Supprimer cette ligne" style="display:inline-block;">−</button>
          </td>
        </tr>
      </template>
    </tbody>
  </table>

  {# ============= TABLEAU VENTES DE VÉLO ============= #}
  <table class="recap-table" x-show="({{ ventesVelo is not empty ? 'true' : 'false' }}) || pending.some(p => p.type === 'bike')">
    <thead>
      <tr>
        <th>Vente</th>
        <th>Qté</th>
        <th>Unitaire</th>
        <th>Sous-total</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {# Lignes existantes (Twig) #}
      {% for v in ventesVelo %}
      <tr>
        <td>{{ v.label }}</td>
        <td>{{ v.quantite }}</td>
        <td>{{ '%.2f'|format(v.prix_ht_snapshot|default(0)) }}</td>
        <td>{{ '%.2f'|format((v.prix_ht_snapshot|default(0)) * (v.quantite|default(1))) }}</td>
        <td style="text-align:center;">
          <button type="button" class="btn-remove-row" title="Supprimer" onclick="if(confirm('Supprimer cette vente ?')){fetch('/tickets/{{ ticket.id }}/prestations/{{ v.id }}/delete',{method:'POST'}).then(r=>r.ok?window.location.reload():alert('Erreur'));}">−</button>
        </td>
      </tr>
      {% endfor %}
      
      {# Lignes nouvelles (Alpine.js) #}
      <template x-for="(p, idx) in pending" :key="(p.id || p.label) + '-bike'">
        <tr x-show="p.type === 'bike'">
          <td x-text="p.label"></td>
          <td x-text="p.qty"></td>
          <td x-text="fmt(p.unit)"></td>
          <td x-text="fmt(p.subtotal)"></td>
          <td style="text-align:center;">
            <button type="button" class="btn-remove-row" @click="removeBikeById(p.id)" title="Supprimer cette ligne" style="display:inline-block;">−</button>
          </td>
        </tr>
      </template>
    </tbody>
  </table>
</div>
