-- Migration 012: create categories table and add category_id to prestations_catalogue (SQLite)\n\nPRAGMA foreign_keys = OFF;\n\nBEGIN TRANSACTION;\n\n-- Create categories table\nCREATE TABLE IF NOT EXISTS categories (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  name TEXT NOT NULL UNIQUE,\n  created_at TEXT DEFAULT (datetime('now'))\n);\n\n-- Add category_id column to prestations_catalogue\nALTER TABLE prestations_catalogue ADD COLUMN category_id INTEGER;\n\n-- Backfill categories from existing categorie text column\nINSERT OR IGNORE INTO categories(name)\n  SELECT DISTINCT TRIM(categorie) FROM prestations_catalogue WHERE TRIM(categorie) <> '';\n\n-- Update prestations_catalogue.category_id using categories table\nUPDATE prestations_catalogue\n  SET category_id = (\n    SELECT id FROM categories WHERE categories.name = TRIM(prestations_catalogue.categorie) LIMIT 1\n  )\n  WHERE TRIM(categorie) <> '';\n\nCOMMIT;\n\nPRAGMA foreign_keys = ON;\n
